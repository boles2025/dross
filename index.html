<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #f1f5f9;
            padding: 16px;
        }

        /* Ù‚Ø³Ù… Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ… */
        .today-section {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .today-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .today-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        .today-item:last-child {
            margin-bottom: 0;
        }

        .today-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .today-status {
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-done {
            background: #22c55e;
            color: white;
        }

        .btn-register {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-register:hover {
            background: #2563eb;
        }

        /* Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alerts-section {
            background: white;
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-right: 8px solid #ef4444;
        }

        .alert-item {
            background: #fef2f2;
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #fee2e2;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-title {
            font-weight: 700;
            font-size: 16px;
        }

        .alert-badge {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
        }

        .alert-details {
            font-size: 14px;
            color: #7f1d1d;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .student-card {
            background: white;
            border-radius: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© - ÙˆÙ„Ø¯ */
        .header-boy {
            background: #1e3a8a;
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© - Ø¨Ù†Øª */
        .header-girl {
            background: #831843;
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .student-name {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(45deg);
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø¯ÙŠØ¯ */
        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
        }

        .card-content.show {
            max-height: 3000px;
        }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© */
        .stats {
            display: flex;
            gap: 20px;
            padding: 16px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat {
            font-size: 14px;
            color: #4b5563;
        }

        .stat span {
            font-weight: 700;
            color: #111827;
            margin-left: 4px;
        }

        /* Ø§Ù„Ù…ÙˆØ§Ø¯ */
        .subjects {
            padding: 20px;
        }

        .subject-item {
            background: #f9fafb;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ */
        .subject-item.level-0 {
            border-right: 6px solid #9ca3af;
        }
        .subject-item.level-1 {
            border-right: 6px solid #6b7280;
        }
        .subject-item.level-2 {
            border-right: 6px solid #4b5563;
        }
        .subject-item.level-3 {
            border-right: 6px solid #374151;
        }
        .subject-item.level-4 {
            border-right: 6px solid #1f2937;
        }
        .subject-item.level-5 {
            border-right: 6px solid #111827;
        }
        .subject-item.level-6 {
            border-right: 6px solid #f97316;
        }
        .subject-item.level-7 {
            border-right: 6px solid #f59e0b;
        }
        .subject-item.level-8 {
            border-right: 6px solid #ef4444;
            background: #fef2f2;
        }
        .subject-item.level-9, .subject-item.level-10, .subject-item.level-11, .subject-item.level-12 {
            border-right: 6px solid #dc2626;
            background: #fee2e2;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .subject-name {
            font-weight: 700;
            font-size: 16px;
        }

        .subject-fee {
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid #e5e7eb;
        }

        /* Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© */
        .days {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .day {
            background: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            border: 1px solid #e5e7eb;
        }

        .day.active {
            background: #111827;
            color: white;
            border-color: #111827;
        }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ø¯Ø© */
        .subject-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #6b7280;
        }

        .subject-stats span {
            font-weight: 700;
            color: #111827;
            margin-left: 4px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress {
            margin-bottom: 12px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #111827;
            border-radius: 20px;
        }

        .progress-fill.alert {
            background: #ef4444;
        }

        .progress-fill.warning {
            background: #f97316;
        }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        .alert-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #fecaca;
        }

        .alert-message i {
            color: #ef4444;
            font-size: 16px;
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ */
        .payment-status {
            padding: 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .status-due {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn-green {
            background: #22c55e;
            color: white;
        }

        .btn-black {
            background: #111827;
            color: white;
        }

        .btn-red {
            background: #ef4444;
            color: white;
        }

        /* Ø§Ù„Ø­ØµØµ ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª */
        .records {
            padding: 20px;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-info {
            font-size: 14px;
        }

        .record-actions {
            display: flex;
            gap: 10px;
        }

        .record-actions button {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 13px;
        }

        .record-actions button:hover {
            color: #111827;
        }

        /* Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
        .add-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 56px;
            height: 56px;
            background: #111827;
            color: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            max-width: 400px;
            width: 100%;
            padding: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            margin-bottom: 16px;
            font-family: 'Cairo', sans-serif;
        }

        .modal-input:focus {
            outline: none;
            border-color: #111827;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        /* Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            display: none;
            z-index: 1001;
        }

        /* Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .days-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .day-option {
            background: #f3f4f6;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid #e5e7eb;
        }

        .day-option.selected {
            background: #111827;
            color: white;
            border-color: #111827;
        }

        /* Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª */
        .empty {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        /* Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
        .ar-num {
            font-weight: 700;
        }

        /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alert-counter {
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            margin-right: 10px;
        }

        /* Ø±Ø³Ø§Ù„Ø© 8 Ø­ØµØµ */
        .eight-alert {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>

<!-- Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
<button class="add-btn" onclick="showModal('student')">
    <i class="fas fa-plus"></i>
</button>

<!-- Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ -->
<div class="toast" id="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸</div>

<!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="max-w-3xl mx-auto" id="app">

    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">ğŸ“‹ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</h1>
        <div class="bg-white px-4 py-2 rounded-full flex items-center">
            <span class="text-gray-500">Ø§Ù„Ø¹Ø¯Ø¯</span>
            <span class="font-bold mr-2" id="total-count">0</span>
        </div>
    </div>

    <!-- Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ… -->
    <div class="today-section" id="today-section">
        <div class="today-title">
            <i class="fas fa-sun text-yellow-500"></i>
            Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…
            <span class="text-sm bg-gray-200 px-3 py-1 rounded-full mr-auto" id="today-count">0</span>
        </div>
        <div id="today-list"></div>
    </div>

    <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div class="alerts-section" id="alerts-section" style="display: none;">
        <div class="today-title">
            <i class="fas fa-exclamation-triangle text-red-500"></i>
            Ù…ÙˆØ§Ø¯ ÙˆØµÙ„Øª Ù„Ù€ Ù¨ Ø­ØµØµ
            <span class="alert-counter" id="alert-count">0</span>
        </div>
        <div id="alerts-list"></div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    <div id="cards-container"></div>

</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù† -->
<div class="modal" id="modal-student">
    <div class="modal-content">
        <h2 class="modal-title">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</h2>
        <input type="text" id="student-name" class="modal-input" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ©</button>
            <button class="btn" style="background:#e5e7eb; flex:1;" onclick="hideModal('student')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© -->
<div class="modal" id="modal-subject">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ“– Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</h2>
        <input type="hidden" id="subject-student-id">
        <input type="text" id="subject-name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="number" id="subject-fee" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="subject-time" class="modal-input" placeholder="Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ø§Ù„: 4:00 Ù…)">
        
        <div class="mb-4">
            <div class="font-bold mb-2 text-sm">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
            <div class="days-selector" id="days-selector"></div>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addSubject()">Ø­ÙØ¸</button>
            <button class="btn" style="background:#e5e7eb; flex:1;" onclick="hideModal('subject')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-attendance">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©</h2>
        <input type="hidden" id="attendance-subject-id">
        <input type="date" id="attendance-date" class="modal-input">
        
        <div class="flex gap-3 mb-4">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="Ø­Ø¶ÙˆØ±" checked class="hidden peer">
                <div class="text-center p-3 border-2 rounded-xl peer-checked:bg-green-500 peer-checked:text-white">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-xl peer-checked:bg-red-500 peer-checked:text-white">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addAttendance()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn" style="background:#e5e7eb; flex:1;" onclick="hideModal('attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© -->
<div class="modal" id="modal-payment">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</h2>
        <input type="hidden" id="payment-subject-id">
        <input type="date" id="payment-date" class="modal-input">
        <input type="number" id="payment-amount" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addPayment()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn" style="background:#e5e7eb; flex:1;" onclick="hideModal('payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-edit-attendance">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ©</h2>
        <input type="hidden" id="edit-attendance-id">
        <input type="date" id="edit-attendance-date" class="modal-input">
        
        <div class="flex gap-3 mb-4">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="Ø­Ø¶ÙˆØ±" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-xl peer-checked:bg-green-500 peer-checked:text-white">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-xl peer-checked:bg-red-500 peer-checked:text-white">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updateAttendance()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e5e7eb; flex:1;" onclick="hideModal('edit-attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø© -->
<div class="modal" id="modal-edit-payment">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ’° ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø©</h2>
        <input type="hidden" id="edit-payment-id">
        <input type="date" id="edit-payment-date" class="modal-input">
        <input type="number" id="edit-payment-amount" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updatePayment()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e5e7eb; flex:1;" onclick="hideModal('edit-payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYbNXkNQy32UnbsUUrTXyoJluZRS3wP1w",
        authDomain: "droos-33ede.firebaseapp.com",
        projectId: "droos-33ede",
        storageBucket: "droos-33ede.firebasestorage.app",
        messagingSenderId: "807210060374",
        appId: "1:807210060374:web:3bdf1e15e44a1795f289f7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'droos-app-v1';

    // State
    const state = {
        students: [],
        subjects: [],
        attendance: [],
        payments: [],
        expanded: {} // Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
    };

    const WEEKDAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    const toArabic = (num) => {
        const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        return num.toString().replace(/\d/g, d => arabic[d]);
    };

    const showToast = (msg) => {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    };

    // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù†Ø³
    const getGender = (name) => {
        const boys = ['Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯', 'Ù…Ø­Ù…ÙˆØ¯', 'Ø¹Ù„ÙŠ', 'Ø­Ø³Ù†', 'Ø­Ø³ÙŠÙ†', 'ÙŠÙˆØ³Ù', 'Ø¹Ù…Ø±', 'Ø®Ø§Ù„Ø¯', 'ÙŠØ§Ø³ÙŠÙ†', 'Ø¢Ø¯Ù…', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…'];
        return boys.some(b => name.includes(b)) ? 'boy' : 'girl';
    };

    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    signInAnonymously(auth).then(() => {
        const path = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

        onSnapshot(path('students'), (snap) => {
            state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
            document.getElementById('total-count').textContent = state.students.length;
        });

        onSnapshot(path('subjects'), (snap) => {
            state.subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        onSnapshot(path('attendance'), (snap) => {
            state.attendance = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        onSnapshot(path('payments'), (snap) => {
            state.payments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });
    });

    // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    function render() {
        renderTodayClasses();
        renderAlerts();
        renderCards();
    }

    // Ø¹Ø±Ø¶ Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…
    function renderTodayClasses() {
        const today = new Date().toISOString().split('T')[0];
        const todayDay = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
        
        const todayClasses = [];
        
        state.subjects.forEach(subject => {
            if (subject.days?.includes(todayDay)) {
                const student = state.students.find(s => s.id === subject.studentId);
                const attendance = state.attendance.find(a => a.subjectId === subject.id && a.date === today);
                
                todayClasses.push({
                    subject,
                    student,
                    status: attendance ? attendance.status : 'pending'
                });
            }
        });

        const container = document.getElementById('today-list');
        const countSpan = document.getElementById('today-count');
        
        countSpan.textContent = todayClasses.length;

        if (todayClasses.length === 0) {
            container.innerHTML = '<div class="empty py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…</div>';
            return;
        }

        let html = '';
        todayClasses.forEach(item => {
            html += `
                <div class="today-item">
                    <div class="today-info">
                        <span>${item.student?.name || ''}</span>
                        <span class="font-bold">${item.subject.name}</span>
                        ${item.subject.time ? `<span class="text-sm text-gray-500">${item.subject.time}</span>` : ''}
                    </div>
                    <div>
                        ${item.status === 'pending' ? 
                            `<button class="btn-register" onclick="quickRegister('${item.subject.id}')">ØªØ³Ø¬ÙŠÙ„</button>` :
                            `<span class="today-status status-done">${item.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'} ${item.status}</span>`
                        }
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù…Ù† Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…
    window.quickRegister = (subjectId) => {
        showModal('attendance', subjectId);
    };

    // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ÙˆØµÙ„Øª Ù„Ù€ 8 Ø­ØµØµ
    function renderAlerts() {
        const alerts = [];
        
        state.subjects.forEach(subject => {
            const attendance = state.attendance.filter(a => a.subjectId === subject.id);
            const payments = state.payments.filter(p => p.subjectId === subject.id);
            
            const sessionsCount = attendance.length;
            const paidCount = payments.length;
            const requiredPayments = Math.floor(sessionsCount / 8);
            
            // Ø¥Ø°Ø§ ÙˆØµÙ„ Ù„Ù€ 8 Ø­ØµØµ Ø£Ùˆ Ø£ÙƒØ«Ø±
            if (sessionsCount >= 8) {
                const student = state.students.find(s => s.id === subject.studentId);
                const pending = requiredPayments - paidCount;
                
                if (pending > 0) {
                    alerts.push({
                        student: student?.name || '',
                        subject: subject.name,
                        sessions: sessionsCount,
                        pending,
                        amount: pending * subject.fee
                    });
                }
            }
        });

        const container = document.getElementById('alerts-list');
        const section = document.getElementById('alerts-section');
        const countSpan = document.getElementById('alert-count');

        if (alerts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        countSpan.textContent = alerts.length;

        let html = '';
        alerts.forEach(alert => {
            html += `
                <div class="alert-item">
                    <div class="alert-header">
                        <span class="alert-title">${alert.subject}</span>
                        <span class="alert-badge">${toArabic(alert.sessions)} Ø­ØµØ©</span>
                    </div>
                    <div class="alert-details">
                        <div>Ø§Ù„Ø·Ø§Ù„Ø¨: ${alert.student}</div>
                        <div class="font-bold mt-2">âš ï¸ Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹ ${toArabic(alert.pending)} Ø¯ÙØ¹Ø© (${toArabic(alert.amount)} Ø¬.Ù…)</div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function renderCards() {
        const container = document.getElementById('cards-container');
        
        if (state.students.length === 0) {
            container.innerHTML = '<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ù†Ø§Ø¡</div>';
            return;
        }

        let html = '';
        state.students.forEach(student => {
            html += renderStudent(student);
        });
        container.innerHTML = html;
    }

    function renderStudent(student) {
        const gender = getGender(student.name);
        const isExpanded = state.expanded[student.id] || false;
        
        const subjects = state.subjects.filter(s => s.studentId === student.id);
        const attendance = state.attendance.filter(a => a.studentId === student.id);
        const payments = state.payments.filter(p => p.studentId === student.id);

        const totalSessions = attendance.length;
        const totalPresence = attendance.filter(a => a.status === 'Ø­Ø¶ÙˆØ±').length;
        const totalAbsence = attendance.filter(a => a.status === 'ØºÙŠØ§Ø¨').length;
        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

        return `
            <div class="student-card">
                <!-- Ø§Ù„Ø±Ø£Ø³ -->
                <div class="${gender === 'boy' ? 'header-boy' : 'header-girl'}" onclick="toggleCard('${student.id}')">
                    <div class="student-name">
                        <span>${gender === 'boy' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                        ${student.name}
                    </div>
                    <div class="expand-icon ${isExpanded ? 'rotated' : ''}">
                        <i class="fas ${isExpanded ? 'fa-minus' : 'fa-plus'}"></i>
                    </div>
                </div>

                <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
                <div class="card-content ${isExpanded ? 'show' : ''}">
                    
                    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                    <div class="stats">
                        <div class="stat"><span class="ar-num">${toArabic(totalSessions)}</span> Ø­ØµØ©</div>
                        <div class="stat"><span class="ar-num">${toArabic(totalPresence)}</span> Ø­Ø¶ÙˆØ±</div>
                        <div class="stat"><span class="ar-num">${toArabic(totalAbsence)}</span> ØºÙŠØ§Ø¨</div>
                        <div class="stat"><span class="ar-num">${toArabic(totalPaid)}</span> Ø¬.Ù…</div>
                    </div>

                    <!-- Ø§Ù„Ù…ÙˆØ§Ø¯ -->
                    <div class="subjects">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold">Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
                            <button class="text-sm bg-gray-200 px-3 py-1 rounded-full" onclick="showModal('subject', '${student.id}')">
                                <i class="fas fa-plus ml-1"></i>Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>

                        ${subjects.length === 0 ? 
                            '<div class="empty py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</div>' : 
                            subjects.map(s => renderSubject(s)).join('')
                        }
                    </div>

                    <!-- Ø§Ù„Ø­ØµØµ -->
                    <div class="records">
                        <h3 class="font-bold mb-3">Ø¢Ø®Ø± Ø§Ù„Ø­ØµØµ</h3>
                        ${renderAttendance(attendance)}
                    </div>

                    <!-- Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª -->
                    <div class="records">
                        <h3 class="font-bold mb-3">Ø¢Ø®Ø± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
                        ${renderPayments(payments)}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSubject(subject) {
        const attendance = state.attendance.filter(a => a.subjectId === subject.id);
        const payments = state.payments.filter(p => p.subjectId === subject.id);
        
        const sessionsCount = attendance.length;
        const presenceCount = attendance.filter(a => a.status === 'Ø­Ø¶ÙˆØ±').length;
        const absenceCount = attendance.filter(a => a.status === 'ØºÙŠØ§Ø¨').length;
        
        const requiredPayments = Math.floor(sessionsCount / 8);
        const paidPayments = payments.length;
        const pendingPayments = requiredPayments - paidPayments;
        
        const sessionsSinceLastPayment = sessionsCount - (paidPayments * 8);
        const progress = (sessionsSinceLastPayment / 8) * 100;

        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ„ÙˆÙŠÙ† (0-12)
        let level = Math.min(sessionsCount, 12);
        let levelClass = `level-${level}`;

        return `
            <div class="subject-item ${levelClass}">
                <div class="subject-header">
                    <span class="subject-name">${subject.name} ${subject.time ? `(${subject.time})` : ''}</span>
                    <span class="subject-fee ar-num">${toArabic(subject.fee)} Ø¬.Ù…</span>
                </div>

                <div class="days">
                    ${WEEKDAYS.map(day => `
                        <span class="day ${subject.days?.includes(day) ? 'active' : ''}">${day}</span>
                    `).join('')}
                </div>

                <div class="subject-stats">
                    <div><span class="ar-num">${toArabic(sessionsCount)}</span> Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    <div><span class="ar-num">${toArabic(presenceCount)}</span> Ø­Ø¶ÙˆØ±</div>
                    <div><span class="ar-num">${toArabic(absenceCount)}</span> ØºÙŠØ§Ø¨</div>
                </div>

                <div class="progress">
                    <div class="progress-label">
                        <span>ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯ÙØ¹Ø©</span>
                        <span class="ar-num">${toArabic(sessionsSinceLastPayment)}/8</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${sessionsCount >= 8 ? 'alert' : sessionsCount >= 7 ? 'warning' : ''}" style="width: ${progress}%"></div>
                    </div>
                </div>

                <!-- Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ 8 Ø­ØµØµ -->
                ${sessionsCount >= 8 && pendingPayments > 0 ? `
                    <div class="eight-alert">
                        <i class="fas fa-exclamation-circle"></i>
                        âš ï¸ ÙˆØµÙ„Øª Ù„Ù€ ${toArabic(sessionsCount)} Ø­ØµØµ - Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹ ${toArabic(pendingPayments)} Ø¯ÙØ¹Ø©
                    </div>
                ` : sessionsCount >= 8 ? `
                    <div class="payment-status status-paid">
                        âœ“ ØªÙ… Ø¯ÙØ¹ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ø­ØªÙ‰ ${toArabic(sessionsCount)} Ø­ØµØ©
                    </div>
                ` : ''}

                ${pendingPayments > 0 && sessionsCount < 8 ? `
                    <div class="payment-status status-warning">
                        Ø³ÙŠØ­ØªØ§Ø¬ Ø¯ÙØ¹Ø© Ø¨Ø¹Ø¯ ${toArabic(8 - sessionsSinceLastPayment)} Ø­ØµØµ
                    </div>
                ` : ''}

                <div class="actions">
                    <button class="btn btn-green" onclick="showModal('attendance', '${subject.id}')">
                        <i class="fas fa-pen"></i> Ø­ØµØ©
                    </button>
                    <button class="btn btn-black" onclick="showModal('payment', '${subject.id}')">
                        <i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹Ø©
                    </button>
                    <button class="btn btn-red" onclick="deleteSubject('${subject.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function renderAttendance(attendance) {
        const recent = [...attendance].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        
        if (recent.length === 0) {
            return '<div class="empty py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ</div>';
        }

        return recent.map(a => {
            const subject = state.subjects.find(s => s.id === a.subjectId);
            return `
                <div class="record-item">
                    <div class="record-info">
                        <div class="font-bold">${subject?.name || ''}</div>
                        <div class="text-sm text-gray-500">${a.date}</div>
                    </div>
                    <div class="record-actions">
                        <span class="${a.status === 'Ø­Ø¶ÙˆØ±' ? 'text-green-600' : 'text-red-600'} ml-3">
                            ${a.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'}
                        </span>
                        <button onclick="editAttendance('${a.id}')"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteAttendance('${a.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderPayments(payments) {
        const recent = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        
        if (recent.length === 0) {
            return '<div class="empty py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>';
        }

        return recent.map(p => {
            const subject = state.subjects.find(s => s.id === p.subjectId);
            return `
                <div class="record-item">
                    <div class="record-info">
                        <div class="font-bold">${subject?.name || ''}</div>
                        <div class="text-sm text-gray-500">${p.date}</div>
                    </div>
                    <div class="record-actions">
                        <span class="text-green-600 font-bold ml-3 ar-num">${toArabic(p.amount)} Ø¬.Ù…</span>
                        <button onclick="editPayment('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePayment('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ…
    window.toggleCard = (id) => {
        state.expanded[id] = !state.expanded[id];
        renderCards();
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ°
    window.showModal = (type, data = null) => {
        if (type === 'subject' && data) {
            document.getElementById('subject-student-id').value = data;
            renderDaysSelector();
        }
        if (type === 'attendance' && data) {
            document.getElementById('attendance-subject-id').value = data;
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
        }
        if (type === 'payment' && data) {
            document.getElementById('payment-subject-id').value = data;
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            const subject = state.subjects.find(s => s.id === data);
            if (subject) {
                document.getElementById('payment-amount').value = subject.fee;
            }
        }
        document.getElementById(`modal-${type}`).classList.add('active');
    };

    window.hideModal = (type) => {
        document.getElementById(`modal-${type}`).classList.remove('active');
    };

    function renderDaysSelector() {
        const container = document.getElementById('days-selector');
        container.innerHTML = '';
        WEEKDAYS.forEach(day => {
            const div = document.createElement('div');
            div.className = 'day-option';
            div.textContent = day;
            div.onclick = () => div.classList.toggle('selected');
            container.appendChild(div);
        });
    }

    // Ø§Ù„Ø·Ù„Ø§Ø¨
    window.addStudent = async () => {
        const name = document.getElementById('student-name').value.trim();
        if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…');
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), { name });
            document.getElementById('student-name').value = '';
            hideModal('student');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ù…ÙˆØ§Ø¯
    window.addSubject = async () => {
        const studentId = document.getElementById('subject-student-id').value;
        const name = document.getElementById('subject-name').value.trim();
        const fee = document.getElementById('subject-fee').value;
        const time = document.getElementById('subject-time').value;
        
        const days = Array.from(document.querySelectorAll('#days-selector .selected')).map(el => el.textContent);

        if (!studentId || !name || !fee || days.length === 0) {
            return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'subjects'), {
                studentId, name, fee: parseFloat(fee), time, days
            });
            hideModal('subject');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deleteSubject = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ø­ØµØµ
    window.addAttendance = async () => {
        const subjectId = document.getElementById('attendance-subject-id').value;
        const date = document.getElementById('attendance-date').value;
        const status = document.querySelector('input[name="attendance-status"]:checked').value;

        if (!subjectId || !date) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const exists = state.attendance.find(a => a.subjectId === subjectId && a.date === date);
        if (exists) return alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                status
            });
            hideModal('attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.editAttendance = (id) => {
        const a = state.attendance.find(a => a.id === id);
        if (!a) return;

        document.getElementById('edit-attendance-id').value = id;
        document.getElementById('edit-attendance-date').value = a.date;
        
        const radio = document.querySelector(`input[name="edit-attendance-status"][value="${a.status}"]`);
        if (radio) radio.checked = true;

        document.getElementById('modal-edit-attendance').classList.add('active');
    };

    window.updateAttendance = async () => {
        const id = document.getElementById('edit-attendance-id').value;
        const date = document.getElementById('edit-attendance-date').value;
        const status = document.querySelector('input[name="edit-attendance-status"]:checked').value;

        if (!id || !date || !status) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id), {
                date, day, status
            });
            hideModal('edit-attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deleteAttendance = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
    window.addPayment = async () => {
        const subjectId = document.getElementById('payment-subject-id').value;
        const date = document.getElementById('payment-date').value;
        const amount = document.getElementById('payment-amount').value;

        if (!subjectId || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'payments'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                amount: parseFloat(amount)
            });
            hideModal('payment');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.editPayment = (id) => {
        const p = state.payments.find(p => p.id === id);
        if (!p) return;

        document.getElementById('edit-payment-id').value = id;
        document.getElementById('edit-payment-date').value = p.date;
        document.getElementById('edit-payment-amount').value = p.amount;

        document.getElementById('modal-edit-payment').classList.add('active');
    };

    window.updatePayment = async () => {
        const id = document.getElementById('edit-payment-id').value;
        const date = document.getElementById('edit-payment-date').value;
        const amount = document.getElementById('edit-payment-amount').value;

        if (!id || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id), {
                date, day, amount: parseFloat(amount)
            });
            hideModal('edit-payment');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deletePayment = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };
</script>
</body>
</html>
