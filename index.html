<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ | Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(145deg, #f6f8fd 0%, #f0f3fa 100%);
            padding: 16px;
            padding-bottom: 80px;
            min-height: 100vh;
            position: relative;
        }

        /* ØªÙˆÙ‚ÙŠØ¹ Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± Ù…ØªØ­Ø±Ùƒ */
        .signature {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 700;
            box-shadow: 0 10px 30px -10px rgba(102, 126, 234, 0.5);
            z-index: 1000;
            animation: float 3s ease-in-out infinite;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .signature i {
            font-size: 20px;
            animation: spin 10s linear infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Ù‚Ø³Ù… Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ… */
        .today-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px -15px rgba(0,0,0,0.1);
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .today-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
        }

        .today-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            border-radius: 20px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        .btn-register {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 6px 20px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px -5px #3b82f6;
        }

        /* Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alerts-section {
            background: white;
            border-radius: 30px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px -15px rgba(239, 68, 68, 0.2);
            border-right: 8px solid #ef4444;
        }

        .alert-item {
            background: #fef2f2;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #fee2e2;
        }

        .alert-badge {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .student-card {
            background: white;
            border-radius: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px -15px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© - ÙˆÙ„Ø¯ */
        .header-boy {
            background: linear-gradient(135deg, #1e3a8a, #2563eb);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© - Ø¨Ù†Øª */
        .header-girl {
            background: linear-gradient(135deg, #831843, #db2777);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .student-name {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }

        .expand-icon.rotated {
            transform: rotate(45deg);
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø¯ÙŠØ¯ */
        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: white;
        }

        .card-content.show {
            max-height: 5000px;
        }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© */
        .stats {
            display: flex;
            gap: 20px;
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .stat {
            font-size: 14px;
            color: #475569;
        }

        .stat span {
            font-weight: 700;
            color: #0f172a;
            margin-left: 4px;
            font-size: 18px;
        }

        /* Ø§Ù„Ù…ÙˆØ§Ø¯ */
        .subjects {
            padding: 20px;
        }

        .subject-item {
            background: #ffffff;
            border-radius: 24px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        /* Ø®Ø· ÙØ§ØµÙ„ Ù„ÙˆÙ†ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ - ÙƒÙ„ Ù…Ø§Ø¯Ø© Ù„Ù‡Ø§ Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù */
        .subject-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            border-radius: 8px 0 0 8px;
        }

        /* Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ù…ÙˆØ§Ø¯ - ÙƒÙ„ Ù…Ø§Ø¯Ø© Ø¨Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù */
        .subject-item:nth-child(1)::before { background: linear-gradient(to bottom, #3b82f6, #1e40af); }
        .subject-item:nth-child(2)::before { background: linear-gradient(to bottom, #10b981, #047857); }
        .subject-item:nth-child(3)::before { background: linear-gradient(to bottom, #f59e0b, #b45309); }
        .subject-item:nth-child(4)::before { background: linear-gradient(to bottom, #ef4444, #b91c1c); }
        .subject-item:nth-child(5)::before { background: linear-gradient(to bottom, #8b5cf6, #5b21b6); }
        .subject-item:nth-child(6)::before { background: linear-gradient(to bottom, #ec4899, #9d174d); }
        .subject-item:nth-child(7)::before { background: linear-gradient(to bottom, #14b8a6, #115e59); }
        .subject-item:nth-child(8)::before { background: linear-gradient(to bottom, #f97316, #c2410c); }

        /* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ */
        .subject-item.level-0 { border-right: 6px solid #94a3b8; }
        .subject-item.level-1 { border-right: 6px solid #64748b; }
        .subject-item.level-2 { border-right: 6px solid #475569; }
        .subject-item.level-3 { border-right: 6px solid #334155; }
        .subject-item.level-4 { border-right: 6px solid #1e293b; }
        .subject-item.level-5 { border-right: 6px solid #0f172a; }
        .subject-item.level-6 { border-right: 6px solid #f97316; background: #fff7ed; }
        .subject-item.level-7 { border-right: 6px solid #f59e0b; background: #fef3c7; }
        .subject-item.level-8 { border-right: 6px solid #ef4444; background: #fef2f2; }
        .subject-item.level-9, .subject-item.level-10, .subject-item.level-11, .subject-item.level-12 {
            border-right: 6px solid #dc2626;
            background: #fee2e2;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .subject-name {
            font-weight: 700;
            font-size: 18px;
            color: #0f172a;
        }

        .subject-fee {
            background: #f1f5f9;
            padding: 5px 15px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            color: #0f172a;
        }

        /* Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© */
        .days {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .day {
            background: #f1f5f9;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 12px;
            color: #334155;
            font-weight: 500;
        }

        .day.active {
            background: #0f172a;
            color: white;
        }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ø¯Ø© */
        .subject-stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px dashed #e2e8f0;
            border-bottom: 1px dashed #e2e8f0;
        }

        .subject-stat {
            font-size: 13px;
            color: #64748b;
        }

        .subject-stat span {
            font-weight: 700;
            color: #0f172a;
            margin-left: 5px;
            font-size: 15px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress {
            margin: 15px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #475569;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 20px;
        }

        .progress-fill.alert {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f97316, #ea580c);
        }

        /* Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ */
        .alert-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px 15px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #fecaca;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-green {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .btn-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .btn-black {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
        }

        .btn-red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª */
        .records {
            padding: 20px;
            background: #f8fafc;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-actions {
            display: flex;
            gap: 12px;
        }

        .record-actions button {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
        }

        .record-actions button:hover {
            color: #0f172a;
        }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 30px;
            max-width: 450px;
            width: 100%;
            padding: 30px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #0f172a;
        }

        .modal-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            margin-bottom: 16px;
            font-family: 'Cairo', sans-serif;
            font-size: 15px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        /* Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .days-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0;
        }

        .day-option {
            background: #f1f5f9;
            padding: 10px 18px;
            border-radius: 40px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .day-option.selected {
            background: #0f172a;
            color: white;
            border-color: #0f172a;
        }

        /* Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #0f172a;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 600;
            display: none;
            z-index: 2001;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª */
        .empty {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        /* Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
        .ar-num {
            font-weight: 700;
        }

        /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alert-counter {
            background: #ef4444;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            margin-right: 10px;
        }

        /* Ø¨Ø§Ù‚ÙŠ ÙƒØ§Ù… Ø­ØµØ© */
        .remaining-badge {
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }
    </style>
</head>
<body>

<!-- ØªÙˆÙ‚ÙŠØ¹ Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ± Ù…ØªØ­Ø±Ùƒ -->
<div class="signature">
    <i class="fas fa-crown"></i>
    Ù…Ù‡Ù†Ø¯Ø³ Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±
    <i class="fas fa-code"></i>
</div>

<!-- Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ -->
<div class="toast" id="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­</div>

<!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="max-w-3xl mx-auto" id="app">

    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">ğŸ“‹ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</h1>
        <div class="bg-white px-4 py-2 rounded-full shadow-sm">
            <span class="text-gray-500">Ø§Ù„Ø¹Ø¯Ø¯</span>
            <span class="font-bold mr-2" id="total-count">0</span>
        </div>
    </div>

    <!-- Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ… -->
    <div class="today-section" id="today-section">
        <div class="today-title">
            <i class="fas fa-sun text-yellow-500"></i>
            Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…
            <span class="text-sm bg-gray-200 px-3 py-1 rounded-full mr-auto" id="today-count">0</span>
        </div>
        <div id="today-list"></div>
    </div>

    <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div class="alerts-section" id="alerts-section" style="display: none;">
        <div class="today-title">
            <i class="fas fa-exclamation-triangle text-red-500"></i>
            Ù…ÙˆØ§Ø¯ ÙˆØµÙ„Øª Ù„Ù€ Ù¨ Ø­ØµØµ
            <span class="alert-counter" id="alert-count">0</span>
        </div>
        <div id="alerts-list"></div>
    </div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    <div id="cards-container"></div>

</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù† (Ù…Ø®ÙÙŠ - ÙŠØ¸Ù‡Ø± Ù…Ù† Ø²Ø± ÙÙŠ Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©) -->
<div class="modal" id="modal-student">
    <div class="modal-content">
        <h2 class="modal-title">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</h2>
        <input type="text" id="student-name" class="modal-input" placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹">
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ©</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('student')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© -->
<div class="modal" id="modal-subject">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ“– Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</h2>
        <input type="hidden" id="subject-student-id">
        <input type="text" id="subject-name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="number" id="subject-fee" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="subject-time" class="modal-input" placeholder="Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ø§Ù„: 4:00 Ù…)">
        
        <div class="mb-2 font-bold">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
        <div class="days-selector" id="days-selector"></div>

        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addSubject()">Ø­ÙØ¸</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('subject')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø© -->
<div class="modal" id="modal-edit-subject">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©</h2>
        <input type="hidden" id="edit-subject-id">
        <input type="text" id="edit-subject-name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="number" id="edit-subject-fee" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="edit-subject-time" class="modal-input" placeholder="Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ø§Ù„: 4:00 Ù…)">
        
        <div class="mb-2 font-bold">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
        <div class="days-selector" id="edit-days-selector"></div>

        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updateSubject()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('edit-subject')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-attendance">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©</h2>
        <input type="hidden" id="attendance-subject-id">
        <input type="date" id="attendance-date" class="modal-input">
        
        <div class="flex gap-3 mb-4">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="Ø­Ø¶ÙˆØ±" checked class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-green-500 peer-checked:text-white">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-red-500 peer-checked:text-white">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addAttendance()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ -->
<div class="modal" id="modal-payment">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹</h2>
        <input type="hidden" id="payment-subject-id">
        <input type="date" id="payment-date" class="modal-input">
        <input type="number" id="payment-amount" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addPayment()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-edit-attendance">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ©</h2>
        <input type="hidden" id="edit-attendance-id">
        <input type="date" id="edit-attendance-date" class="modal-input">
        
        <div class="flex gap-3 mb-4">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="Ø­Ø¶ÙˆØ±" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-green-500 peer-checked:text-white">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-red-500 peer-checked:text-white">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updateAttendance()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('edit-attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹ -->
<div class="modal" id="modal-edit-payment">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ’° ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹</h2>
        <input type="hidden" id="edit-payment-id">
        <input type="date" id="edit-payment-date" class="modal-input">
        <input type="number" id="edit-payment-amount" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updatePayment()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('edit-payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYbNXkNQy32UnbsUUrTXyoJluZRS3wP1w",
        authDomain: "droos-33ede.firebaseapp.com",
        projectId: "droos-33ede",
        storageBucket: "droos-33ede.firebasestorage.app",
        messagingSenderId: "807210060374",
        appId: "1:807210060374:web:3bdf1e15e44a1795f289f7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'droos-app-v1';

    // State
    const state = {
        students: [],
        subjects: [],
        attendance: [],
        payments: [],
        expanded: {}
    };

    const WEEKDAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    const toArabic = (num) => {
        const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        return num.toString().replace(/\d/g, d => arabic[d]);
    };

    const showToast = (msg) => {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    };

    const getGender = (name) => {
        const boys = ['Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯', 'Ù…Ø­Ù…ÙˆØ¯', 'Ø¹Ù„ÙŠ', 'Ø­Ø³Ù†', 'Ø­Ø³ÙŠÙ†', 'ÙŠÙˆØ³Ù', 'Ø¹Ù…Ø±', 'Ø®Ø§Ù„Ø¯', 'ÙŠØ§Ø³ÙŠÙ†', 'Ø¢Ø¯Ù…', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…'];
        return boys.some(b => name.includes(b)) ? 'boy' : 'girl';
    };

    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    signInAnonymously(auth).then(() => {
        const path = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

        onSnapshot(path('students'), (snap) => {
            state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
            document.getElementById('total-count').textContent = state.students.length;
        });

        onSnapshot(path('subjects'), (snap) => {
            state.subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        onSnapshot(path('attendance'), (snap) => {
            state.attendance = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        onSnapshot(path('payments'), (snap) => {
            state.payments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });
    });

    function render() {
        renderTodayClasses();
        renderAlerts();
        renderCards();
    }

    // Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…
    function renderTodayClasses() {
        const today = new Date().toISOString().split('T')[0];
        const todayDay = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
        
        const todayClasses = [];
        
        state.subjects.forEach(subject => {
            if (subject.days?.includes(todayDay)) {
                const student = state.students.find(s => s.id === subject.studentId);
                const attendance = state.attendance.find(a => a.subjectId === subject.id && a.date === today);
                
                todayClasses.push({
                    subject,
                    student,
                    status: attendance ? attendance.status : 'pending'
                });
            }
        });

        const container = document.getElementById('today-list');
        const countSpan = document.getElementById('today-count');
        
        countSpan.textContent = todayClasses.length;

        if (todayClasses.length === 0) {
            container.innerHTML = '<div class="empty py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…</div>';
            return;
        }

        let html = '';
        todayClasses.forEach(item => {
            html += `
                <div class="today-item">
                    <div class="flex items-center gap-3">
                        <span class="font-bold">${item.student?.name || ''}</span>
                        <span>${item.subject.name}</span>
                        ${item.subject.time ? `<span class="text-sm text-gray-500">${item.subject.time}</span>` : ''}
                    </div>
                    <div>
                        ${item.status === 'pending' ? 
                            `<button class="btn-register" onclick="quickRegister('${item.subject.id}')">ØªØ³Ø¬ÙŠÙ„</button>` :
                            `<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">${item.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'} ${item.status}</span>`
                        }
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    window.quickRegister = (subjectId) => {
        showModal('attendance', subjectId);
    };

    // Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function renderAlerts() {
        const alerts = [];
        
        state.subjects.forEach(subject => {
            const attendance = state.attendance.filter(a => a.subjectId === subject.id);
            const payments = state.payments.filter(p => p.subjectId === subject.id);
            
            const sessionsCount = attendance.length;
            const paidCount = payments.length;
            const requiredPayments = Math.floor(sessionsCount / 8);
            
            if (sessionsCount >= 8) {
                const student = state.students.find(s => s.id === subject.studentId);
                const pending = requiredPayments - paidCount;
                
                if (pending > 0) {
                    alerts.push({
                        student: student?.name || '',
                        subject: subject.name,
                        sessions: sessionsCount,
                        pending,
                        amount: pending * subject.fee
                    });
                }
            }
        });

        const container = document.getElementById('alerts-list');
        const section = document.getElementById('alerts-section');
        const countSpan = document.getElementById('alert-count');

        if (alerts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        countSpan.textContent = alerts.length;

        let html = '';
        alerts.forEach(alert => {
            html += `
                <div class="alert-item">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold">${alert.subject}</span>
                        <span class="alert-badge">${toArabic(alert.sessions)} Ø­ØµØ©</span>
                    </div>
                    <div class="text-sm text-red-800">
                        <div>Ø§Ù„Ø·Ø§Ù„Ø¨: ${alert.student}</div>
                        <div class="font-bold mt-2">âš ï¸ Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹ ${toArabic(alert.pending)} Ø¯ÙØ¹ (${toArabic(alert.amount)} Ø¬.Ù…)</div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    function renderCards() {
        const container = document.getElementById('cards-container');
        
        if (state.students.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-3xl p-12 text-center">
                    <i class="fas fa-child text-5xl text-gray-300 mb-3"></i>
                    <p class="text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ù†Ø§Ø¡</p>
                    <button class="btn btn-black mt-4 px-6" onclick="showModal('student')">Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†</button>
                </div>
            `;
            return;
        }

        let html = '';
        state.students.forEach(student => {
            html += renderStudent(student);
        });
        container.innerHTML = html;
    }

    function renderStudent(student) {
        const gender = getGender(student.name);
        const isExpanded = state.expanded[student.id] || false;
        
        const subjects = state.subjects.filter(s => s.studentId === student.id);
        const attendance = state.attendance.filter(a => a.studentId === student.id);
        const payments = state.payments.filter(p => p.studentId === student.id);

        const totalSessions = attendance.length;
        const totalPresence = attendance.filter(a => a.status === 'Ø­Ø¶ÙˆØ±').length;
        const totalAbsence = attendance.filter(a => a.status === 'ØºÙŠØ§Ø¨').length;
        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

        return `
            <div class="student-card">
                <div class="${gender === 'boy' ? 'header-boy' : 'header-girl'}" onclick="toggleCard('${student.id}')">
                    <div class="student-name">
                        <span>${gender === 'boy' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                        ${student.name}
                    </div>
                    <div class="expand-icon ${isExpanded ? 'rotated' : ''}">
                        <i class="fas ${isExpanded ? 'fa-minus' : 'fa-plus'}"></i>
                    </div>
                </div>

                <div class="card-content ${isExpanded ? 'show' : ''}">
                    
                    <div class="stats">
                        <div class="stat"><span class="ar-num">${toArabic(totalSessions)}</span> Ø­ØµØ©</div>
                        <div class="stat"><span class="ar-num">${toArabic(totalPresence)}</span> Ø­Ø¶ÙˆØ±</div>
                        <div class="stat"><span class="ar-num">${toArabic(totalAbsence)}</span> ØºÙŠØ§Ø¨</div>
                        <div class="stat"><span class="ar-num">${toArabic(totalPaid)}</span> Ø¬.Ù…</div>
                    </div>

                    <div class="subjects">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
                            <button class="bg-gray-200 px-4 py-2 rounded-full text-sm" onclick="showModal('subject', '${student.id}')">
                                <i class="fas fa-plus ml-1"></i>Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>

                        ${subjects.length === 0 ? 
                            '<div class="empty py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</div>' : 
                            subjects.map((s, index) => renderSubject(s, index)).join('')
                        }
                    </div>

                    <div class="records">
                        <h3 class="font-bold mb-3">Ø¢Ø®Ø± Ø§Ù„Ø­ØµØµ</h3>
                        ${renderAttendance(attendance)}
                    </div>

                    <div class="records">
                        <h3 class="font-bold mb-3">Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹</h3>
                        ${renderPayments(payments)}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSubject(subject, index) {
        const attendance = state.attendance.filter(a => a.subjectId === subject.id);
        const payments = state.payments.filter(p => p.subjectId === subject.id);
        
        const sessionsCount = attendance.length;
        const presenceCount = attendance.filter(a => a.status === 'Ø­Ø¶ÙˆØ±').length;
        const absenceCount = attendance.filter(a => a.status === 'ØºÙŠØ§Ø¨').length;
        
        const requiredPayments = Math.floor(sessionsCount / 8);
        const paidPayments = payments.length;
        const pendingPayments = requiredPayments - paidPayments;
        
        const sessionsSinceLastPayment = sessionsCount - (paidPayments * 8);
        const progress = (sessionsSinceLastPayment / 8) * 100;
        const remainingForNext = 8 - sessionsSinceLastPayment;

        let level = Math.min(sessionsCount, 12);
        let levelClass = `level-${level}`;

        return `
            <div class="subject-item ${levelClass}" style="animation: fadeIn 0.3s ease-out ${index * 0.1}s both;">
                <div class="subject-header">
                    <span class="subject-name">${subject.name}</span>
                    <span class="subject-fee ar-num">${toArabic(subject.fee)} Ø¬.Ù…</span>
                </div>

                <div class="text-sm text-gray-500 mb-2">${subject.time || ''}</div>

                <div class="days">
                    ${WEEKDAYS.map(day => `
                        <span class="day ${subject.days?.includes(day) ? 'active' : ''}">${day}</span>
                    `).join('')}
                </div>

                <div class="subject-stats">
                    <div class="subject-stat"><span class="ar-num">${toArabic(sessionsCount)}</span> Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    <div class="subject-stat"><span class="ar-num">${toArabic(presenceCount)}</span> Ø­Ø¶ÙˆØ±</div>
                    <div class="subject-stat"><span class="ar-num">${toArabic(absenceCount)}</span> ØºÙŠØ§Ø¨</div>
                </div>

                <div class="progress">
                    <div class="progress-label">
                        <span>Ø¨Ø§Ù‚ÙŠ ${toArabic(remainingForNext)} Ø­ØµØ© Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…</span>
                        <span class="remaining-badge ar-num">${toArabic(sessionsSinceLastPayment)}/8</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${sessionsCount >= 8 ? 'alert' : sessionsCount >= 6 ? 'warning' : ''}" style="width: ${progress}%"></div>
                    </div>
                </div>

                ${sessionsCount >= 8 && pendingPayments > 0 ? `
                    <div class="alert-message">
                        <i class="fas fa-exclamation-circle"></i>
                        âš ï¸ ÙˆØµÙ„Øª Ù„Ù€ ${toArabic(sessionsCount)} Ø­ØµØµ - Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹ ${toArabic(pendingPayments)} Ø¯ÙØ¹
                    </div>
                ` : sessionsCount >= 8 ? `
                    <div class="bg-green-100 text-green-700 p-3 rounded-2xl text-sm font-bold mb-3">
                        âœ“ ØªÙ… Ø¯ÙØ¹ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ­Ù‚
                    </div>
                ` : ''}

                <div class="actions">
                    <button class="btn btn-green" onclick="showModal('attendance', '${subject.id}')">
                        <i class="fas fa-pen"></i> Ø­ØµØ©
                    </button>
                    <button class="btn btn-black" onclick="showModal('payment', '${subject.id}')">
                        <i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹
                    </button>
                    <button class="btn btn-blue" onclick="editSubject('${subject.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-red" onclick="deleteSubject('${subject.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function renderAttendance(attendance) {
        const recent = [...attendance].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        
        if (recent.length === 0) {
            return '<div class="empty py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ</div>';
        }

        return recent.map(a => {
            const subject = state.subjects.find(s => s.id === a.subjectId);
            return `
                <div class="record-item">
                    <div>
                        <div class="font-bold">${subject?.name || ''}</div>
                        <div class="text-sm text-gray-500">${a.date}</div>
                    </div>
                    <div class="record-actions">
                        <span class="${a.status === 'Ø­Ø¶ÙˆØ±' ? 'text-green-600' : 'text-red-600'} ml-3">
                            ${a.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'}
                        </span>
                        <button onclick="editAttendance('${a.id}')"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteAttendance('${a.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderPayments(payments) {
        const recent = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        
        if (recent.length === 0) {
            return '<div class="empty py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>';
        }

        return recent.map(p => {
            const subject = state.subjects.find(s => s.id === p.subjectId);
            return `
                <div class="record-item">
                    <div>
                        <div class="font-bold">${subject?.name || ''}</div>
                        <div class="text-sm text-gray-500">${p.date}</div>
                    </div>
                    <div class="record-actions">
                        <span class="text-green-600 font-bold ml-3 ar-num">${toArabic(p.amount)} Ø¬.Ù…</span>
                        <button onclick="editPayment('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePayment('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    window.toggleCard = (id) => {
        state.expanded[id] = !state.expanded[id];
        renderCards();
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ°
    window.showModal = (type, data = null) => {
        if (type === 'subject' && data) {
            document.getElementById('subject-student-id').value = data;
            renderDaysSelector('days-selector');
        }
        if (type === 'attendance' && data) {
            document.getElementById('attendance-subject-id').value = data;
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
        }
        if (type === 'payment' && data) {
            document.getElementById('payment-subject-id').value = data;
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            const subject = state.subjects.find(s => s.id === data);
            if (subject) {
                document.getElementById('payment-amount').value = subject.fee;
            }
        }
        document.getElementById(`modal-${type}`).classList.add('active');
    };

    window.hideModal = (type) => {
        document.getElementById(`modal-${type}`).classList.remove('active');
    };

    // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©
    window.editSubject = (id) => {
        const subject = state.subjects.find(s => s.id === id);
        if (!subject) return;

        document.getElementById('edit-subject-id').value = id;
        document.getElementById('edit-subject-name').value = subject.name;
        document.getElementById('edit-subject-fee').value = subject.fee;
        document.getElementById('edit-subject-time').value = subject.time || '';

        const container = document.getElementById('edit-days-selector');
        container.innerHTML = '';
        WEEKDAYS.forEach(day => {
            const div = document.createElement('div');
            div.className = `day-option ${subject.days?.includes(day) ? 'selected' : ''}`;
            div.textContent = day;
            div.onclick = () => div.classList.toggle('selected');
            container.appendChild(div);
        });

        document.getElementById('modal-edit-subject').classList.add('active');
    };

    window.updateSubject = async () => {
        const id = document.getElementById('edit-subject-id').value;
        const name = document.getElementById('edit-subject-name').value.trim();
        const fee = document.getElementById('edit-subject-fee').value;
        const time = document.getElementById('edit-subject-time').value;
        const days = Array.from(document.querySelectorAll('#edit-days-selector .selected')).map(el => el.textContent);

        if (!name || !fee || days.length === 0) {
            return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id), {
                name, fee: parseFloat(fee), time, days
            });
            hideModal('edit-subject');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    function renderDaysSelector(selectorId) {
        const container = document.getElementById(selectorId);
        container.innerHTML = '';
        WEEKDAYS.forEach(day => {
            const div = document.createElement('div');
            div.className = 'day-option';
            div.textContent = day;
            div.onclick = () => div.classList.toggle('selected');
            container.appendChild(div);
        });
    }

    // Ø§Ù„Ø·Ù„Ø§Ø¨
    window.addStudent = async () => {
        const name = document.getElementById('student-name').value.trim();
        if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…');
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), { name });
            document.getElementById('student-name').value = '';
            hideModal('student');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ù…ÙˆØ§Ø¯
    window.addSubject = async () => {
        const studentId = document.getElementById('subject-student-id').value;
        const name = document.getElementById('subject-name').value.trim();
        const fee = document.getElementById('subject-fee').value;
        const time = document.getElementById('subject-time').value;
        
        const days = Array.from(document.querySelectorAll('#days-selector .selected')).map(el => el.textContent);

        if (!studentId || !name || !fee || days.length === 0) {
            return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'subjects'), {
                studentId, name, fee: parseFloat(fee), time, days
            });
            hideModal('subject');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deleteSubject = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ø­ØµØµ
    window.addAttendance = async () => {
        const subjectId = document.getElementById('attendance-subject-id').value;
        const date = document.getElementById('attendance-date').value;
        const status = document.querySelector('input[name="attendance-status"]:checked').value;

        if (!subjectId || !date) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const exists = state.attendance.find(a => a.subjectId === subjectId && a.date === date);
        if (exists) return alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                status
            });
            hideModal('attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.editAttendance = (id) => {
        const a = state.attendance.find(a => a.id === id);
        if (!a) return;

        document.getElementById('edit-attendance-id').value = id;
        document.getElementById('edit-attendance-date').value = a.date;
        
        const radio = document.querySelector(`input[name="edit-attendance-status"][value="${a.status}"]`);
        if (radio) radio.checked = true;

        document.getElementById('modal-edit-attendance').classList.add('active');
    };

    window.updateAttendance = async () => {
        const id = document.getElementById('edit-attendance-id').value;
        const date = document.getElementById('edit-attendance-date').value;
        const status = document.querySelector('input[name="edit-attendance-status"]:checked').value;

        if (!id || !date || !status) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id), {
                date, day, status
            });
            hideModal('edit-attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deleteAttendance = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
    window.addPayment = async () => {
        const subjectId = document.getElementById('payment-subject-id').value;
        const date = document.getElementById('payment-date').value;
        const amount = document.getElementById('payment-amount').value;

        if (!subjectId || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'payments'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                amount: parseFloat(amount)
            });
            hideModal('payment');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.editPayment = (id) => {
        const p = state.payments.find(p => p.id === id);
        if (!p) return;

        document.getElementById('edit-payment-id').value = id;
        document.getElementById('edit-payment-date').value = p.date;
        document.getElementById('edit-payment-amount').value = p.amount;

        document.getElementById('modal-edit-payment').classList.add('active');
    };

    window.updatePayment = async () => {
        const id = document.getElementById('edit-payment-id').value;
        const date = document.getElementById('edit-payment-date').value;
        const amount = document.getElementById('edit-payment-amount').value;

        if (!id || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id), {
                date, day, amount: parseFloat(amount)
            });
            hideModal('edit-payment');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deletePayment = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };
</script>
</body>
</html>
