<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة الدروس | م. بولس سمير</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
        }
        .card {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .gradient-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        .day-checkbox:checked + label {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
    </style>
</head>
<body class="p-2 md:p-6">

    <div id="loading" class="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <div id="loading-text" class="text-indigo-600 font-bold">جاري الاتصال بالسحابة...</div>
        </div>
    </div>

    <!-- Session Details Modal -->
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[110] flex items-center justify-center p-4">
        <div class="card w-full max-w-md p-6 relative shadow-2xl">
            <button onclick="closeModal()" class="absolute top-4 left-4 text-gray-400 hover:text-gray-600 text-xl font-bold">✕</button>
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-indigo-700 text-center border-b pb-2">تفاصيل الحصص</h3>
            <div class="max-h-96 overflow-y-auto">
                <table class="w-full text-right border-collapse">
                    <thead>
                        <tr class="border-b text-gray-500 text-sm">
                            <th class="py-2 text-right">التاريخ</th>
                            <th class="py-2 text-center">رقم الحصة</th>
                            <th class="py-2 text-center">اليوم</th>
                        </tr>
                    </thead>
                    <tbody id="modal-body"></tbody>
                </table>
            </div>
            <button onclick="closeModal()" class="w-full mt-4 bg-indigo-50 text-indigo-700 py-2 rounded-xl font-bold">إغلاق</button>
        </div>
    </div>

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="gradient-header text-white rounded-2xl p-6 mb-8 shadow-xl text-center relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-3xl font-bold">نظام متابعة دروس الأبناء</h1>
                <p class="mt-2 text-indigo-100 opacity-90 font-medium">إشراف وتصميم: المهندس بولس سمير</p>
                <div id="auth-status" class="mt-2 text-xs bg-black/20 inline-block px-3 py-1 rounded-full">جاري التحقق من الاتصال...</div>
            </div>
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-white opacity-10 rounded-full"></div>
        </header>

        <!-- Navigation -->
        <div class="flex flex-wrap gap-2 mb-8 justify-center">
            <button onclick="switchTab('dashboard')" class="tab-btn px-5 py-2.5 bg-indigo-600 text-white rounded-xl shadow-md transition-all">لوحة التحكم</button>
            <button onclick="switchTab('students')" class="tab-btn px-5 py-2.5 bg-white text-gray-700 rounded-xl border border-gray-200 hover:bg-gray-50 transition-all">الإعدادات والجدول</button>
            <button onclick="switchTab('attendance')" class="tab-btn px-5 py-2.5 bg-white text-gray-700 rounded-xl border border-gray-200 hover:bg-gray-50 transition-all">تسجيل الحضور</button>
            <button onclick="switchTab('reports')" class="tab-btn px-5 py-2.5 bg-white text-gray-700 rounded-xl border border-gray-200 hover:bg-gray-50 transition-all">التقارير والمصاريف</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6 border-b-4 border-indigo-500">
                    <h3 class="text-gray-500 text-sm text-right">إجمالي حصص الحضور</h3>
                    <p id="total-sessions" class="text-3xl font-bold text-indigo-700 text-right">0</p>
                </div>
                <div class="card p-6 border-b-4 border-emerald-500">
                    <h3 class="text-gray-500 text-sm text-right">إجمالي التكلفة الشهرية</h3>
                    <p id="total-paid" class="text-3xl font-bold text-emerald-700 text-right">0 ج.م</p>
                </div>
                <div class="card p-6 border-b-4 border-amber-500">
                    <h3 class="text-gray-500 text-sm text-right">عدد الأبناء</h3>
                    <p id="total-students-count" class="text-3xl font-bold text-amber-700 text-right">0</p>
                </div>
            </div>
            
            <div class="mt-8 card p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-indigo-600 rounded-full"></span>
                    آخر عمليات التسجيل
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 uppercase text-xs">
                                <th class="p-4">التاريخ</th>
                                <th class="p-4">الابن</th>
                                <th class="p-4">المادة</th>
                                <th class="p-4 text-center">رقم الحصة</th>
                                <th class="p-4 text-center">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="recent-logs" class="text-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Students & Schedule Tab -->
        <div id="students-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-6">
                    <h2 class="text-lg font-bold mb-4 text-indigo-700 border-b pb-2">إضافة ابن جديد</h2>
                    <div class="flex gap-2">
                        <input id="student-name" type="text" placeholder="اسم الابن..." class="flex-1 p-3 border rounded-xl outline-none focus:border-indigo-500 transition-colors">
                        <button onclick="addStudent()" class="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700 transition">إضافة</button>
                    </div>
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-600 mb-3 text-sm">قائمة الأبناء:</h3>
                        <div id="students-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="card p-6">
                    <h2 class="text-lg font-bold mb-4 text-emerald-700 border-b pb-2">إضافة مادة وجدول المواعيد</h2>
                    <div class="space-y-4">
                        <select id="parent-student" class="w-full p-3 border rounded-xl outline-none focus:border-emerald-500"></select>
                        <div class="grid grid-cols-2 gap-3">
                            <input id="subject-name" type="text" placeholder="اسم المادة" class="p-3 border rounded-xl outline-none focus:border-emerald-500">
                            <input id="subject-fee" type="number" placeholder="المبلغ الشهري" class="p-3 border rounded-xl outline-none focus:border-emerald-500">
                        </div>
                        <div>
                            <p class="text-sm font-bold text-gray-600 mb-2 text-right">أيام الدرس:</p>
                            <div class="flex flex-wrap gap-2 justify-start" id="days-selector"></div>
                        </div>
                        <button onclick="addSubject()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">حفظ المادة</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 card p-6">
                <h2 class="text-lg font-bold mb-4 text-right">جدول المواد الأسبوعي</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-right border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-xs text-gray-500">
                                <th class="p-3">الابن</th>
                                <th class="p-3">المادة</th>
                                <th class="p-3">أيام الدرس</th>
                                <th class="p-3 text-right">المبلغ</th>
                                <th class="p-3 text-center">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="subjects-table-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance-tab" class="tab-content hidden">
            <div class="card p-8 max-w-xl mx-auto border-t-8 border-indigo-600 shadow-2xl">
                <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">تسجيل حضور جديد</h2>
                <div class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-bold text-gray-600 block text-right mb-1">الابن</label>
                            <select id="att-student" onchange="updateAttSubjects()" class="w-full p-3 border rounded-xl outline-none focus:border-indigo-500 text-right"></select>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-600 block text-right mb-1">المادة</label>
                            <select id="att-subject" class="w-full p-3 border rounded-xl outline-none focus:border-indigo-500 text-right"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-bold text-gray-600 block text-right mb-1">التاريخ</label>
                            <input id="att-date" type="date" onchange="updateDayName()" class="w-full p-3 border rounded-xl outline-none focus:border-indigo-500 text-right">
                        </div>
                        <div>
                            <label class="text-sm font-bold text-gray-600 block text-right mb-1">اليوم</label>
                            <input id="att-day" type="text" readonly class="w-full p-3 border rounded-xl bg-indigo-50 text-indigo-700 font-bold outline-none text-right">
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl flex items-center justify-around">
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="radio" name="status" value="حضور" checked class="w-4 h-4 text-indigo-600">
                            <span class="font-bold text-green-600 group-hover:underline">حضور</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer group">
                            <input type="radio" name="status" value="غياب" class="w-4 h-4 text-red-600">
                            <span class="font-bold text-red-600 group-hover:underline">غياب</span>
                        </label>
                    </div>
                    <button id="save-btn" onclick="saveAttendance()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl disabled:opacity-50 hover:bg-indigo-700 transition-all transform active:scale-95">تأكيد التسجيل</button>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content hidden">
            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4 border-b pb-2 flex justify-between items-center">
                    <span>كشف حساب المصروفات</span>
                    <button onclick="updateUI()" class="text-xs text-indigo-600 hover:underline">تحديث البيانات ↻</button>
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-right border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600">
                                <th class="p-4 border-b text-right">الابن</th>
                                <th class="p-4 border-b text-right">المادة</th>
                                <th class="p-4 border-b text-center">عدد الحصص</th>
                                <th class="p-4 border-b text-right">التكلفة</th>
                                <th class="p-4 border-b text-center">الإجراء</th>
                            </tr>
                        </thead>
                        <tbody id="financial-report"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-2xl shadow-2xl opacity-0 transition-opacity pointer-events-none z-[200]"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Configuration priority: Environment config then fallback
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAYbNXkNQy32UnbsUUrTXyoJluZRS3wP1w",
            authDomain: "droos-33ede.firebaseapp.com",
            databaseURL: "https://droos-33ede-default-rtdb.firebaseio.com",
            projectId: "droos-33ede",
            storageBucket: "droos-33ede.firebasestorage.app",
            messagingSenderId: "807210060374",
            appId: "1:807210060374:web:3bdf1e15e44a1795f289f7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'droos-app-v1';

        // State
        window.appState = {
            students: [],
            subjects: [],
            attendance: [],
            user: null,
            isInitializing: true
        };

        const WEEKDAYS = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];

        // Init App
        async function init() {
            renderDaySelectors();
            const authStatus = document.getElementById('auth-status');
            
            // Core Authentication Workflow
            const initAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            return;
                        } catch (e) {
                            console.warn("Custom token sign-in failed, falling back to anonymous.");
                        }
                    }
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth System Error:", error);
                    authStatus.textContent = "❌ خطأ في الاتصال بالسحابة: " + error.code;
                    authStatus.className = "mt-2 text-xs bg-red-500/20 text-red-100 inline-block px-3 py-1 rounded-full";
                }
            };

            await initAuth();

            onAuthStateChanged(auth, (user) => {
                window.appState.user = user;
                if (user) {
                    authStatus.textContent = "✅ متصل بالسحابة";
                    authStatus.className = "mt-2 text-xs bg-green-500/20 text-green-100 inline-block px-3 py-1 rounded-full";
                    setupListeners();
                } else {
                    authStatus.textContent = "⚠️ غير متصل";
                }
            });

            document.getElementById('att-date').valueAsDate = new Date();
            updateDayName();
        }

        function setupListeners() {
            if (!window.appState.user) return;
            const path = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

            onSnapshot(path('students'), (snap) => {
                window.appState.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateUI();
                if(window.appState.isInitializing) {
                    document.getElementById('loading').style.display = 'none';
                    window.appState.isInitializing = false;
                }
            });

            onSnapshot(path('subjects'), (snap) => {
                window.appState.subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateUI();
            });

            onSnapshot(path('attendance'), (snap) => {
                window.appState.attendance = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateUI();
            });
        }

        // --- Actions ---
        window.addStudent = async () => {
            if (!window.appState.user) return showToast("انتظر الاتصال بالسحابة...");
            const name = document.getElementById('student-name').value.trim();
            if (!name) return showToast("يرجى إدخال اسم الابن");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), { name });
                document.getElementById('student-name').value = '';
                showToast("تمت الإضافة بنجاح");
            } catch (e) { showToast("خطأ في الحفظ: " + e.code); }
        };

        window.addSubject = async () => {
            if (!window.appState.user) return showToast("انتظر الاتصال بالسحابة...");
            const studentId = document.getElementById('parent-student').value;
            const name = document.getElementById('subject-name').value.trim();
            const fee = document.getElementById('subject-fee').value;
            const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked')).map(cb => cb.value);
            if (!studentId || !name || !fee || selectedDays.length === 0) return showToast("يرجى إكمال كافة البيانات");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'subjects'), {
                    studentId, name, fee: parseFloat(fee), days: selectedDays
                });
                document.getElementById('subject-name').value = '';
                document.getElementById('subject-fee').value = '';
                document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
                showToast("تم حفظ المادة");
            } catch (e) { showToast("خطأ في الحفظ: " + e.code); }
        };

        window.saveAttendance = async () => {
            if (!window.appState.user) return showToast("انتظر الاتصال بالسحابة...");
            const btn = document.getElementById('save-btn');
            const studentId = document.getElementById('att-student').value;
            const subjectId = document.getElementById('att-subject').value;
            const date = document.getElementById('att-date').value;
            const day = document.getElementById('att-day').value;
            const status = document.querySelector('input[name="status"]:checked').value;
            if (!studentId || !subjectId || !date) return showToast("يرجى إكمال بيانات الحضور");
            btn.disabled = true;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                    studentId, subjectId, date, day, status, timestamp: Date.now()
                });
                showToast("تم تسجيل " + status);
            } catch (e) { showToast("خطأ في التسجيل: " + e.code); }
            btn.disabled = false;
        };

        window.deleteStudent = async (id) => {
            if (!window.appState.user) return;
            if (confirm("سيتم حذف الابن وكل بياناته، هل أنت متأكد؟")) {
                try {
                    const subsToDelete = window.appState.subjects.filter(s => s.studentId === id);
                    for (let s of subsToDelete) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', s.id));
                    }
                    const attsToDelete = window.appState.attendance.filter(a => a.studentId === id);
                    for (let a of attsToDelete) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', a.id));
                    }
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id));
                    showToast("تم حذف الابن بنجاح");
                } catch (e) { showToast("خطأ في الحذف: " + e.message); }
            }
        };

        window.deleteSubject = async (id) => {
            if (!window.appState.user) return;
            if (confirm("حذف هذه المادة؟")) {
                try {
                    const atts = window.appState.attendance.filter(a => a.subjectId === id);
                    for (let a of atts) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', a.id));
                    }
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id));
                    showToast("تم الحذف");
                } catch (e) { showToast("خطأ في الحذف"); }
            }
        };

        window.resetSubject = async (subId) => {
            if (!window.appState.user) return;
            if (confirm("تصفير حصص الشهر؟")) {
                try {
                    const batch = window.appState.attendance.filter(a => a.subjectId === subId);
                    for (let a of batch) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', a.id));
                    }
                    showToast("تم التصفير");
                } catch (e) { showToast("خطأ في التصفير"); }
            }
        };

        // UI Helpers
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const target = document.getElementById(tabName + '-tab');
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                b.classList.add('bg-white', 'text-gray-700', 'border');
            });
            if (event && event.target) {
                event.target.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                event.target.classList.remove('bg-white', 'text-gray-700', 'border');
            }
        };

        window.updateDayName = () => {
            const dateVal = document.getElementById('att-date').value;
            if (dateVal) {
                const date = new Date(dateVal);
                const dayName = date.toLocaleDateString('ar-EG', { weekday: 'long' });
                document.getElementById('att-day').value = dayName;
            }
        };

        window.updateAttSubjects = () => {
            const studentId = document.getElementById('att-student').value;
            const select = document.getElementById('att-subject');
            select.innerHTML = '<option value="">-- اختر المادة --</option>';
            window.appState.subjects.filter(s => s.studentId === studentId).forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.name} (${s.days.join(' - ')})`;
                select.appendChild(opt);
            });
        };

        function renderDaySelectors() {
            const container = document.getElementById('days-selector');
            if(!container) return;
            WEEKDAYS.forEach(day => {
                container.innerHTML += `
                    <div class="relative">
                        <input type="checkbox" id="day-${day}" value="${day}" class="hidden day-checkbox">
                        <label for="day-${day}" class="px-3 py-1.5 border border-gray-200 rounded-lg text-xs cursor-pointer hover:bg-gray-50 transition-all block">
                            ${day}
                        </label>
                    </div>
                `;
            });
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        window.showSessionDetails = (subId) => {
            const subject = window.appState.subjects.find(s => s.id === subId);
            // Sort ascending to calculate session numbers correctly
            const sessions = window.appState.attendance
                .filter(a => a.subjectId === subId && a.status === 'حضور')
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            document.getElementById('modal-title').textContent = `حصص مادة: ${subject ? subject.name : ''}`;
            const body = document.getElementById('modal-body');
            
            // Map with index and then reverse to show latest first in display
            body.innerHTML = sessions.map((s, index) => `
                <tr class="border-b text-sm hover:bg-indigo-50 transition">
                    <td class="py-3 text-right">${s.date}</td>
                    <td class="py-3 text-center font-bold text-indigo-700">${index + 1}</td>
                    <td class="py-3 text-center text-gray-600">${s.day}</td>
                </tr>
            `).reverse().join('') || '<tr><td colspan="3" class="text-center py-4 text-gray-400">لا توجد حصص مسجلة</td></tr>';

            document.getElementById('details-modal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('details-modal').classList.add('hidden');
        };

        window.updateUI = () => {
            const state = window.appState;

            // Update Dropdowns
            const pSt = document.getElementById('parent-student');
            const aSt = document.getElementById('att-student');
            if (pSt && aSt) {
                [pSt, aSt].forEach(s => {
                    const cur = s.value;
                    s.innerHTML = '<option value="">-- اختر الابن --</option>';
                    state.students.forEach(st => {
                        const opt = document.createElement('option');
                        opt.value = st.id; opt.textContent = st.name;
                        s.appendChild(opt);
                    });
                    s.value = cur;
                });
            }

            // Update Stats
            const ts = document.getElementById('total-sessions');
            const tc = document.getElementById('total-students-count');
            const tp = document.getElementById('total-paid');
            if (ts) ts.textContent = state.attendance.filter(a => a.status === 'حضور').length;
            if (tc) tc.textContent = state.students.length;
            if (tp) tp.textContent = state.subjects.reduce((sum, s) => sum + s.fee, 0) + " ج.م";

            // Update Lists
            const sl = document.getElementById('students-list');
            if (sl) sl.innerHTML = state.students.map(s => `
                <div class="bg-gray-100 px-4 py-2 rounded-xl flex items-center gap-3 border shadow-sm">
                    <span class="font-bold">${s.name}</span>
                    <button onclick="deleteStudent('${s.id}')" class="text-red-400 hover:text-red-600 font-bold p-1">✕</button>
                </div>
            `).join('');

            const stl = document.getElementById('subjects-table-list');
            if (stl) stl.innerHTML = state.subjects.map(s => {
                const student = state.students.find(st => st.id === s.studentId);
                return `
                    <tr class="border-b text-sm hover:bg-gray-50 transition">
                        <td class="p-3 text-right">${student ? student.name : '?'}</td>
                        <td class="p-3 font-bold text-indigo-700 text-right">${s.name}</td>
                        <td class="p-3 text-right"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs">${s.days.join('، ')}</span></td>
                        <td class="p-3 font-bold text-right">${s.fee} ج.م</td>
                        <td class="p-3 text-center"><button onclick="deleteSubject('${s.id}')" class="text-red-500 hover:underline">حذف</button></td>
                    </tr>
                `;
            }).join('');

            const rl = document.getElementById('recent-logs');
            if (rl) {
                const logs = [...state.attendance].sort((a,b) => b.timestamp - a.timestamp).slice(0, 10);
                rl.innerHTML = logs.map(a => {
                    const student = state.students.find(s => s.id === a.studentId);
                    const subject = state.subjects.find(s => s.id === a.subjectId);
                    let sessionNum = "---";
                    if (a.status === 'حضور') {
                        const history = state.attendance
                            .filter(att => att.studentId === a.studentId && att.subjectId === a.subjectId && att.status === 'حضور')
                            .sort((x, y) => x.timestamp - y.timestamp);
                        const index = history.findIndex(h => h.id === a.id);
                        sessionNum = index !== -1 ? (index + 1) : "---";
                    }

                    return `
                        <tr class="border-b text-sm hover:bg-gray-50 transition">
                            <td class="p-4 font-medium text-right">${a.date}</td>
                            <td class="p-4 font-bold text-gray-800 text-right">${student ? student.name : '---'}</td>
                            <td class="p-4 text-indigo-600 font-semibold text-right">${subject ? subject.name : '---'}</td>
                            <td class="p-4 text-center">
                                ${a.status === 'حضور' ? 
                                `<button onclick="showSessionDetails('${a.subjectId}')" class="font-bold text-indigo-600 hover:underline cursor-pointer bg-indigo-50 px-3 py-1 rounded-full">
                                    ${sessionNum}
                                </button>` : '---'}
                            </td>
                            <td class="p-4 text-center">
                                <span class="${a.status === 'حضور' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} px-3 py-1 rounded-full text-xs font-bold">
                                    ${a.status}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            const fr = document.getElementById('financial-report');
            if (fr) fr.innerHTML = state.subjects.map(sub => {
                const student = state.students.find(st => st.id === sub.studentId);
                const count = state.attendance.filter(a => a.subjectId === sub.id && a.status === 'حضور').length;
                return `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-4 font-semibold text-right">${student ? student.name : '---'}</td>
                        <td class="p-4 text-right">${sub.name}</td>
                        <td class="p-4 text-center">
                            <button onclick="showSessionDetails('${sub.id}')" class="font-bold text-indigo-700 bg-indigo-50 px-3 py-1 rounded-full hover:bg-indigo-100 transition shadow-sm border border-indigo-100">
                                ${count} حصة
                            </button>
                        </td>
                        <td class="p-4 font-bold text-emerald-700 text-right">${sub.fee} ج.م</td>
                        <td class="p-4 text-center">
                            <button onclick="resetSubject('${sub.id}')" class="text-xs bg-orange-100 text-orange-700 px-3 py-1 rounded-lg hover:bg-orange-200">تصفير</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.onload = init;
    </script>
</body>
</html>