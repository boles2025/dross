<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³ | Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</title>
    <!-- Tailwind Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø®Ø· Ø®ÙÙŠÙ ÙˆØ³Ø±ÙŠØ¹ -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ - ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø±Ù†Ø¯Ø± */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(165deg, #1e1b4b 0%, #312e81 50%, #3730a3 100%);
            padding: 12px;
            padding-bottom: 90px;
            min-height: 100vh;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± */
        .container-custom {
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
        }

        /* ØªÙˆÙ‚ÙŠØ¹ Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† ØªØ¹Ù‚ÙŠØ¯ */
        .signature {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: white;
            padding: 6px 18px;
            border-radius: 40px;
            font-weight: 700;
            border: 1.5px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Ù‚Ø³Ù… Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ… - ØªØµÙ…ÙŠÙ… Ø³Ø±ÙŠØ¹ ÙˆÙˆØ§Ø¶Ø­ */
        .today-section {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 32px;
            padding: 20px 16px;
            margin-bottom: 16px;
            box-shadow: 0 20px 35px -10px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .today-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f172a;
        }

        .today-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            background: #f8fafc;
            border-radius: 28px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .btn-register {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 22px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 10px -3px #059669;
        }

        /* Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alerts-section {
            background: #fff1f0;
            border-radius: 32px;
            padding: 20px 16px;
            margin-bottom: 16px;
            border: 1px solid #fecaca;
        }

        .alert-item {
            background: white;
            border-radius: 28px;
            padding: 16px;
            margin-bottom: 10px;
            border: 1px solid #fca5a5;
        }

        .alert-badge {
            background: #dc2626;
            color: white;
            padding: 5px 16px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 700;
        }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø³Ø±ÙŠØ¹Ø© ÙˆØ®ÙÙŠÙØ© */
        .student-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 40px;
            margin-bottom: 20px;
            box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.9);
        }

        .header-boy {
            background: #2563eb;
            color: white;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .header-girl {
            background: #db2777;
            color: white;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .student-name {
            font-size: 18px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expand-icon {
            font-size: 18px;
            transition: transform 0.2s;
            background: rgba(255,255,255,0.3);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 30px;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .card-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: #f9fafb;
        }

        .card-content.show {
            max-height: 8000px;
        }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© - Ø´Ø¨ÙƒØ© Ù…Ø±Ù†Ø© */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            padding: 16px;
            background: #f1f5f9;
        }

        .stat {
            font-size: 13px;
            color: #334155;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            background: white;
            padding: 8px 4px;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            font-weight: 600;
        }

        .stat span {
            font-weight: 800;
            color: #0f172a;
            font-size: 18px;
            line-height: 1.3;
            background: #f1f5f9;
            padding: 2px 8px;
            border-radius: 20px;
            margin-bottom: 4px;
            width: 100%;
        }

        /* Ø§Ù„Ù…ÙˆØ§Ø¯ */
        .subjects {
            padding: 20px 16px;
        }

        .subject-item {
            background: white;
            border-radius: 32px;
            padding: 18px 16px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
            position: relative;
            box-shadow: 0 5px 10px rgba(0,0,0,0.02);
        }

        /* ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ 8 Ø­ØµØµ ÙØ£ÙƒØ«Ø± */
        .subject-item.warning-level {
            background: #fef2f2;
            border: 2px solid #ef4444;
            box-shadow: 0 10px 20px -8px #ef4444;
        }
        .subject-item.warning-level .subject-name {
            color: #b91c1c;
        }
        .subject-item.warning-level .subject-fee {
            background: #ef4444;
        }
        .subject-item.warning-level .day.active {
            background: #b91c1c;
        }
        .subject-item.warning-level .progress-fill {
            background: linear-gradient(90deg, #ef4444, #b91c1c);
        }
        .subject-item.warning-level .remaining-badge {
            background: #ef4444;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 6px;
        }

        .subject-name {
            font-weight: 800;
            font-size: 18px;
            color: #0f172a;
        }

        .subject-fee {
            background: #3b82f6;
            padding: 5px 18px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
            color: white;
        }

        .days {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin: 12px 0;
        }

        .day {
            background: #f1f5f9;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 12px;
            color: #1e293b;
            font-weight: 600;
            border: 1px solid #e2e8f0;
        }

        .day.active {
            background: #0f172a;
            color: white;
        }

        .subject-stats {
            display: flex;
            gap: 8px;
            margin: 12px 0;
            padding: 8px 0;
            border-top: 1px dashed #cbd5e1;
            border-bottom: 1px dashed #cbd5e1;
            flex-wrap: wrap;
        }

        .subject-stat {
            font-size: 13px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            background: #f8fafc;
            padding: 4px 12px;
            border-radius: 30px;
            border: 1px solid #e2e8f0;
            font-weight: 600;
        }

        .subject-stat span {
            font-weight: 800;
            color: #0f172a;
            font-size: 14px;
            background: white;
            padding: 2px 8px;
            border-radius: 20px;
        }

        .progress {
            margin: 15px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #334155;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .progress-bar {
            height: 12px;
            background: #e2e8f0;
            border-radius: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 20px;
            transition: width 0.2s;
        }

        .alert-message {
            background: #fee2e2;
            color: #7f1d1d;
            padding: 12px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 700;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #fecaca;
        }

        .actions {
            display: flex;
            gap: 6px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 28px;
            font-size: 13px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 65px;
            color: white;
        }

        .btn-green { background: #059669; }
        .btn-blue { background: #2563eb; }
        .btn-black { background: #1e293b; }
        .btn-red { background: #dc2626; }

        .records {
            padding: 20px 16px;
            background: #f1f5f9;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: white;
            border-radius: 30px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .record-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .record-actions button {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 14px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .record-actions button:hover {
            background: #1e293b;
            color: white;
        }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© - Ø³Ø±ÙŠØ¹Ø© ÙˆÙˆØ§Ø¶Ø­Ø© */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 48px;
            max-width: 480px;
            width: 100%;
            padding: 28px 20px;
            box-shadow: 0 30px 50px #000;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 24px;
            color: #0f172a;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 40px;
            margin-bottom: 16px;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .days-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 16px 0;
            justify-content: center;
        }

        .day-option {
            background: #f1f5f9;
            padding: 12px 16px;
            border-radius: 40px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            font-weight: 600;
        }

        .day-option.selected {
            background: #0f172a;
            color: white;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 14px 30px;
            border-radius: 50px;
            font-weight: 700;
            display: none;
            z-index: 2001;
            box-shadow: 0 15px 25px rgba(0,0,0,0.3);
            font-size: 15px;
            white-space: nowrap;
        }

        .empty {
            text-align: center;
            padding: 30px;
            color: #64748b;
            background: white;
            border-radius: 32px;
            border: 1px dashed #cbd5e1;
        }

        .alert-counter {
            background: #dc2626;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 800;
            margin-right: 10px;
        }

        .remaining-badge {
            background: #3b82f6;
            padding: 5px 16px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 700;
            color: white;
        }

        /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØµ */
        .sessions-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .session-item {
            background: #f8fafc;
            border-radius: 50px;
            padding: 14px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #e2e8f0;
            gap: 8px;
        }
        .session-number {
            background: #3b82f6;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            flex-shrink: 0;
        }
        .session-info {
            flex: 1;
            padding-right: 8px;
        }
        .session-date {
            font-weight: 700;
            color: #0f172a;
            font-size: 14px;
        }
        .session-day {
            font-size: 13px;
            color: #64748b;
        }
        .session-status-badge {
            padding: 5px 12px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 13px;
        }
        .status-present {
            background: #d1fae5;
            color: #065f46;
        }
        .status-absent {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .session-delete-btn {
            background: #fee2e2;
            border: none;
            color: #dc2626;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø«Ø§Ø¨Øª ÙˆØ³Ø±ÙŠØ¹ */
        .add-student-fab {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4f46e5;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 60px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 15px 25px -8px #1e1b4b;
            z-index: 1000;
            border: 2px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 480px) {
            body {
                padding: 8px;
                padding-bottom: 100px;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .stat {
                flex-direction: row;
                justify-content: space-between;
                padding: 8px 12px;
            }
            .stat span {
                width: auto;
                margin-bottom: 0;
            }
            .actions {
                gap: 4px;
            }
            .btn {
                padding: 10px 4px;
                font-size: 12px;
            }
            .subject-name {
                font-size: 16px;
            }
            .add-student-fab {
                padding: 12px 20px;
                font-size: 16px;
            }
            .subject-fee {
                padding: 4px 12px;
                font-size: 13px;
            }
        }

        /* Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© */
        .ar-num {
            font-feature-settings: "ss01";
        }
    </style>
</head>
<body>

<div class="container-custom">
    <!-- Ø±Ø£Ø³ Ø³Ø±ÙŠØ¹ ÙˆÙˆØ§Ø¶Ø­ -->
    <div class="flex justify-between items-center mb-4 gap-2">
        <h1 class="text-xl md:text-2xl font-extrabold text-white flex items-center gap-2 bg-black/20 px-4 py-2 rounded-full">
            <i class="fas fa-book-open"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³
        </h1>
        <div class="signature">
            <i class="fas fa-crown"></i>
            <span>Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</span>
        </div>
        <div class="bg-white/90 px-4 py-2 rounded-full shadow-lg">
            <span class="text-gray-600 text-sm">Ø§Ù„Ø¹Ø¯Ø¯</span>
            <span class="font-bold mr-1 text-indigo-700 text-base" id="total-count">0</span>
        </div>
    </div>

    <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div class="max-w-7xl mx-auto" id="app">

        <!-- Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ… -->
        <div class="today-section" id="today-section">
            <div class="today-title">
                <i class="fas fa-sun text-yellow-500"></i>
                Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…
                <span class="text-sm bg-indigo-600 text-white px-4 py-1.5 rounded-full mr-auto font-bold" id="today-count">0</span>
            </div>
            <div id="today-list"></div>
        </div>

        <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
        <div class="alerts-section" id="alerts-section" style="display: none;">
            <div class="today-title">
                <i class="fas fa-exclamation-triangle text-red-500"></i>
                Ù…ÙˆØ§Ø¯ ÙˆØµÙ„Øª Ù„Ù€ Ù¨ Ø­ØµØµ
                <span class="alert-counter" id="alert-count">0</span>
            </div>
            <div id="alerts-list"></div>
        </div>

        <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
        <div id="cards-container"></div>
    </div>
</div>

<!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø© Ø«Ø§Ø¨Øª ÙˆØ³Ø±ÙŠØ¹ -->
<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù† -->
<div class="modal" id="modal-student">
    <div class="modal-content">
        <h2 class="modal-title">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†/Ø§Ø¨Ù†Ø©</h2>
        <input type="text" id="student-name" class="modal-input" placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ø§Ù‹">
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ©</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('student')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© -->
<div class="modal" id="modal-subject">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ“– Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</h2>
        <input type="hidden" id="subject-student-id">
        <input type="text" id="subject-name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="number" id="subject-fee" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="subject-time" class="modal-input" placeholder="Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ø§Ù„: 4:00 Ù…)">
        <div class="mb-2 font-bold">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
        <div class="days-selector" id="days-selector"></div>
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addSubject()">Ø­ÙØ¸</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('subject')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø© -->
<div class="modal" id="modal-edit-subject">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©</h2>
        <input type="hidden" id="edit-subject-id">
        <input type="text" id="edit-subject-name" class="modal-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="number" id="edit-subject-fee" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input type="text" id="edit-subject-time" class="modal-input" placeholder="Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ø§Ù„: 4:00 Ù…)">
        <div class="mb-2 font-bold">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
        <div class="days-selector" id="edit-days-selector"></div>
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updateSubject()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('edit-subject')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-attendance">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©</h2>
        <input type="hidden" id="attendance-subject-id">
        <input type="date" id="attendance-date" class="modal-input">
        <div class="flex flex-wrap gap-2 mb-4">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="Ø­Ø¶ÙˆØ±" checked class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-green-500 peer-checked:text-white font-bold text-sm">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-red-500 peer-checked:text-white font-bold text-sm">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addAttendance()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ -->
<div class="modal" id="modal-payment">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹</h2>
        <input type="hidden" id="payment-subject-id">
        <input type="date" id="payment-date" class="modal-input">
        <input type="number" id="payment-amount" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="addPayment()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-edit-attendance">
    <div class="modal-content">
        <h2 class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ©</h2>
        <input type="hidden" id="edit-attendance-id">
        <input type="date" id="edit-attendance-date" class="modal-input">
        <div class="flex flex-wrap gap-2 mb-4">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="Ø­Ø¶ÙˆØ±" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-green-500 peer-checked:text-white font-bold text-sm">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-3 border-2 rounded-2xl peer-checked:bg-red-500 peer-checked:text-white font-bold text-sm">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updateAttendance()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('edit-attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹ -->
<div class="modal" id="modal-edit-payment">
    <div class="modal-content">
        <h2 class="modal-title">ğŸ’° ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹</h2>
        <input type="hidden" id="edit-payment-id">
        <input type="date" id="edit-payment-date" class="modal-input">
        <input type="number" id="edit-payment-amount" class="modal-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <div class="modal-buttons">
            <button class="btn btn-black flex-1" onclick="updatePayment()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn" style="background:#e2e8f0; color:#475569; flex:1;" onclick="hideModal('edit-payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØµ -->
<div class="modal" id="modal-sessions-detail">
    <div class="modal-content" style="max-width: 600px;">
        <h2 class="modal-title" id="sessions-modal-title">ğŸ“… ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØµ</h2>
        <div id="sessions-list-container" class="sessions-list"></div>
        <div class="modal-buttons mt-4">
            <button class="btn btn-black flex-1" onclick="hideModal('sessions-detail')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYbNXkNQy32UnbsUUrTXyoJluZRS3wP1w",
        authDomain: "droos-33ede.firebaseapp.com",
        projectId: "droos-33ede",
        storageBucket: "droos-33ede.firebasestorage.app",
        messagingSenderId: "807210060374",
        appId: "1:807210060374:web:3bdf1e15e44a1795f289f7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'droos-app-v1';

    // State Ø³Ø±ÙŠØ¹
    const state = {
        students: [],
        subjects: [],
        attendance: [],
        payments: [],
        expanded: {}
    };

    const WEEKDAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø³Ø±ÙŠØ¹Ø©
    const toArabic = (num) => {
        const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        return num.toString().replace(/\d/g, d => arabic[d]);
    };

    const showToast = (msg) => {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 1500);
    };

    const getGender = (name) => {
        const boys = ['Ù…Ø­Ù…Ø¯', 'Ø£Ø­Ù…Ø¯', 'Ù…Ø­Ù…ÙˆØ¯', 'Ø¹Ù„ÙŠ', 'Ø­Ø³Ù†', 'Ø­Ø³ÙŠÙ†', 'ÙŠÙˆØ³Ù', 'Ø¹Ù…Ø±', 'Ø®Ø§Ù„Ø¯', 'ÙŠØ§Ø³ÙŠÙ†', 'Ø¢Ø¯Ù…', 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…'];
        return boys.some(b => name.includes(b)) ? 'boy' : 'girl';
    };

    // Ø§ØªØµØ§Ù„ Firebase
    signInAnonymously(auth).then(() => {
        const path = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

        onSnapshot(path('students'), (snap) => {
            state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
            document.getElementById('total-count').textContent = state.students.length;
        });

        onSnapshot(path('subjects'), (snap) => {
            state.subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        onSnapshot(path('attendance'), (snap) => {
            state.attendance = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });

        onSnapshot(path('payments'), (snap) => {
            state.payments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
        });
    });

    function render() {
        renderTodayClasses();
        renderAlerts();
        renderCards();
    }

    // Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…
    function renderTodayClasses() {
        const today = new Date().toISOString().split('T')[0];
        const todayDay = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
        
        const todayClasses = [];
        
        state.subjects.forEach(subject => {
            if (subject.days?.includes(todayDay)) {
                const student = state.students.find(s => s.id === subject.studentId);
                const attendance = state.attendance.find(a => a.subjectId === subject.id && a.date === today);
                
                todayClasses.push({
                    subject,
                    student,
                    status: attendance ? attendance.status : 'pending'
                });
            }
        });

        const container = document.getElementById('today-list');
        const countSpan = document.getElementById('today-count');
        
        countSpan.textContent = todayClasses.length;

        if (todayClasses.length === 0) {
            container.innerHTML = '<div class="empty py-4">âœ¨ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…</div>';
            return;
        }

        let html = '';
        todayClasses.forEach(item => {
            html += `
                <div class="today-item">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="font-bold">${item.student?.name || ''}</span>
                        <span class="text-indigo-600">${item.subject.name}</span>
                        ${item.subject.time ? `<span class="text-xs bg-gray-200 px-2 py-1 rounded-full">${item.subject.time}</span>` : ''}
                    </div>
                    <div>
                        ${item.status === 'pending' ? 
                            `<button class="btn-register" onclick="quickRegister('${item.subject.id}')">ØªØ³Ø¬ÙŠÙ„</button>` :
                            `<span class="px-3 py-1.5 bg-green-100 text-green-700 rounded-full text-xs font-bold">${item.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'} ${item.status}</span>`
                        }
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    window.quickRegister = (subjectId) => {
        showModal('attendance', subjectId);
    };

    // Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function renderAlerts() {
        const alerts = [];
        
        state.subjects.forEach(subject => {
            const attendance = state.attendance.filter(a => a.subjectId === subject.id);
            const payments = state.payments.filter(p => p.subjectId === subject.id);
            
            const sessionsCount = attendance.length;
            const paidCount = payments.length;
            const requiredPayments = Math.floor(sessionsCount / 8);
            
            if (sessionsCount >= 8) {
                const student = state.students.find(s => s.id === subject.studentId);
                const pending = requiredPayments - paidCount;
                
                if (pending > 0) {
                    alerts.push({
                        student: student?.name || '',
                        subject: subject.name,
                        sessions: sessionsCount,
                        pending,
                        amount: pending * subject.fee
                    });
                }
            }
        });

        const container = document.getElementById('alerts-list');
        const section = document.getElementById('alerts-section');
        const countSpan = document.getElementById('alert-count');

        if (alerts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        countSpan.textContent = alerts.length;

        let html = '';
        alerts.forEach(alert => {
            html += `
                <div class="alert-item">
                    <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                        <span class="font-bold text-red-800">${alert.subject}</span>
                        <span class="alert-badge">${toArabic(alert.sessions)} Ø­ØµØ©</span>
                    </div>
                    <div class="text-sm text-red-900">
                        <div>Ø§Ù„Ø·Ø§Ù„Ø¨: ${alert.student}</div>
                        <div class="font-bold mt-2">âš ï¸ Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹ ${toArabic(alert.pending)} Ø¯ÙØ¹Ø© (${toArabic(alert.amount)} Ø¬.Ù…)</div>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    // Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    function renderCards() {
        const container = document.getElementById('cards-container');
        
        if (state.students.length === 0) {
            container.innerHTML = `
                <div class="bg-white/90 rounded-4xl p-10 text-center border border-white shadow-xl">
                    <i class="fas fa-child text-5xl text-indigo-400 mb-3"></i>
                    <p class="text-gray-600 text-xl mb-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¨Ù†Ø§Ø¡ Ø¨Ø¹Ø¯</p>
                    <button class="btn btn-black px-6 py-3 text-base" onclick="showModal('student')">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù†</button>
                </div>
            `;
            return;
        }

        let html = '';
        state.students.forEach(student => {
            html += renderStudent(student);
        });
        container.innerHTML = html;
    }

    function renderStudent(student) {
        const gender = getGender(student.name);
        const isExpanded = state.expanded[student.id] || false;
        
        const subjects = state.subjects.filter(s => s.studentId === student.id);
        const attendance = state.attendance.filter(a => a.studentId === student.id);
        const payments = state.payments.filter(p => p.studentId === student.id);

        const totalSessions = attendance.length;
        const totalPresence = attendance.filter(a => a.status === 'Ø­Ø¶ÙˆØ±').length;
        const totalAbsence = attendance.filter(a => a.status === 'ØºÙŠØ§Ø¨').length;
        const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);

        return `
            <div class="student-card">
                <div class="${gender === 'boy' ? 'header-boy' : 'header-girl'}" onclick="toggleCard('${student.id}')">
                    <div class="student-name">
                        <span>${gender === 'boy' ? 'ğŸ‘¦' : 'ğŸ‘§'}</span>
                        ${student.name}
                    </div>
                    <div class="expand-icon ${isExpanded ? 'rotated' : ''}">
                        <i class="fas ${isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'}"></i>
                    </div>
                </div>

                <div class="card-content ${isExpanded ? 'show' : ''}">
                    
                    <div class="stats">
                        <div class="stat" onclick="showSessionsDetail('all', '${student.id}')"><span class="ar-num">${toArabic(totalSessions)}</span> Ø­ØµØ©</div>
                        <div class="stat" onclick="showSessionsDetail('present', '${student.id}')"><span class="ar-num">${toArabic(totalPresence)}</span> Ø­Ø¶ÙˆØ±</div>
                        <div class="stat" onclick="showSessionsDetail('absent', '${student.id}')"><span class="ar-num">${toArabic(totalAbsence)}</span> ØºÙŠØ§Ø¨</div>
                        <div class="stat"><span class="ar-num">${toArabic(totalPaid)}</span> Ø¬.Ù…</div>
                    </div>

                    <div class="subjects">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-lg">Ø§Ù„Ù…ÙˆØ§Ø¯</h3>
                            <button class="bg-indigo-600 text-white px-4 py-2 rounded-full text-xs font-bold" onclick="showModal('subject', '${student.id}')">
                                <i class="fas fa-plus ml-1"></i>Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>

                        ${subjects.length === 0 ? 
                            '<div class="empty py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</div>' : 
                            subjects.map((s, index) => renderSubject(s, index)).join('')
                        }
                    </div>

                    <div class="records">
                        <h3 class="font-bold mb-3">Ø¢Ø®Ø± Ø§Ù„Ø­ØµØµ</h3>
                        ${renderAttendance(attendance)}
                    </div>

                    <div class="records">
                        <h3 class="font-bold mb-3">Ø¢Ø®Ø± Ø§Ù„Ø¯ÙØ¹</h3>
                        ${renderPayments(payments)}
                    </div>
                </div>
            </div>
        `;
    }

    function renderSubject(subject, index) {
        const attendance = state.attendance.filter(a => a.subjectId === subject.id);
        const payments = state.payments.filter(p => p.subjectId === subject.id);
        
        const sessionsCount = attendance.length;
        const presenceCount = attendance.filter(a => a.status === 'Ø­Ø¶ÙˆØ±').length;
        const absenceCount = attendance.filter(a => a.status === 'ØºÙŠØ§Ø¨').length;
        
        const requiredPayments = Math.floor(sessionsCount / 8);
        const paidPayments = payments.length;
        const pendingPayments = requiredPayments - paidPayments;
        
        const sessionsSinceLastPayment = sessionsCount - (paidPayments * 8);
        const progress = (sessionsSinceLastPayment / 8) * 100;

        // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø§Ø¯Ø© ÙÙŠ Ø­Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± (8 Ø­ØµØµ ÙØ£ÙƒØ«Ø±)
        const isWarning = sessionsCount >= 8;

        return `
            <div class="subject-item ${isWarning ? 'warning-level' : ''}">
                <div class="subject-header">
                    <span class="subject-name">${subject.name}</span>
                    <span class="subject-fee ar-num">${toArabic(subject.fee)} Ø¬.Ù…</span>
                </div>

                <div class="text-xs text-gray-500 mb-2"><i class="far fa-clock ml-1"></i> ${subject.time || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>

                <div class="days">
                    ${WEEKDAYS.map(day => `
                        <span class="day ${subject.days?.includes(day) ? 'active' : ''}">${day}</span>
                    `).join('')}
                </div>

                <div class="subject-stats">
                    <div class="subject-stat" onclick="showSessionsDetail('subject', '${subject.id}', 'all')"><span class="ar-num">${toArabic(sessionsCount)}</span> Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                    <div class="subject-stat" onclick="showSessionsDetail('subject', '${subject.id}', 'present')"><span class="ar-num">${toArabic(presenceCount)}</span> Ø­Ø¶ÙˆØ±</div>
                    <div class="subject-stat" onclick="showSessionsDetail('subject', '${subject.id}', 'absent')"><span class="ar-num">${toArabic(absenceCount)}</span> ØºÙŠØ§Ø¨</div>
                </div>

                <div class="progress">
                    <div class="progress-label">
                        <span>ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯ÙØ¹Ø©</span>
                        <span class="remaining-badge ar-num">${toArabic(sessionsSinceLastPayment)} / 8</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>

                ${sessionsCount >= 8 && pendingPayments > 0 ? `
                    <div class="alert-message">
                        <i class="fas fa-exclamation-circle"></i>
                        ÙˆØµÙ„Øª Ù„Ù€ ${toArabic(sessionsCount)} - Ù…Ø·Ù„ÙˆØ¨ Ø¯ÙØ¹ ${toArabic(pendingPayments)} Ø¯ÙØ¹Ø©
                    </div>
                ` : sessionsCount >= 8 ? `
                    <div class="bg-green-100 text-green-700 p-2 rounded-2xl text-xs font-bold mb-2 text-center border border-green-200">
                        âœ… ØªÙ… Ø§Ù„Ø¯ÙØ¹
                    </div>
                ` : ''}

                <div class="actions">
                    <button class="btn btn-green" onclick="showModal('attendance', '${subject.id}')"><i class="fas fa-pen"></i> Ø­ØµØ©</button>
                    <button class="btn btn-black" onclick="showModal('payment', '${subject.id}')"><i class="fas fa-money-bill-wave"></i> Ø¯ÙØ¹</button>
                    <button class="btn btn-blue" onclick="editSubject('${subject.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-red" onclick="deleteSubject('${subject.id}')"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
    }

    function renderAttendance(attendance) {
        const recent = [...attendance].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
        
        if (recent.length === 0) {
            return '<div class="empty py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ</div>';
        }

        return recent.map(a => {
            const subject = state.subjects.find(s => s.id === a.subjectId);
            return `
                <div class="record-item">
                    <div>
                        <div class="font-bold text-sm">${subject?.name || ''}</div>
                        <div class="text-xs text-gray-500">${a.date}</div>
                    </div>
                    <div class="record-actions">
                        <span class="${a.status === 'Ø­Ø¶ÙˆØ±' ? 'text-green-600' : 'text-red-600'} text-base">${a.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'}</span>
                        <button onclick="editAttendance('${a.id}')"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteAttendance('${a.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderPayments(payments) {
        const recent = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
        
        if (recent.length === 0) {
            return '<div class="empty py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>';
        }

        return recent.map(p => {
            const subject = state.subjects.find(s => s.id === p.subjectId);
            return `
                <div class="record-item">
                    <div>
                        <div class="font-bold text-sm">${subject?.name || ''}</div>
                        <div class="text-xs text-gray-500">${p.date}</div>
                    </div>
                    <div class="record-actions">
                        <span class="text-green-600 font-bold ar-num text-sm">${toArabic(p.amount)} Ø¬.Ù…</span>
                        <button onclick="editPayment('${p.id}')"><i class="fas fa-edit"></i></button>
                        <button onclick="deletePayment('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    window.toggleCard = (id) => {
        state.expanded[id] = !state.expanded[id];
        renderCards();
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ°
    window.showModal = (type, data = null) => {
        if (type === 'subject' && data) {
            document.getElementById('subject-student-id').value = data;
            renderDaysSelector('days-selector');
        }
        if (type === 'attendance' && data) {
            document.getElementById('attendance-subject-id').value = data;
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
        }
        if (type === 'payment' && data) {
            document.getElementById('payment-subject-id').value = data;
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            const subject = state.subjects.find(s => s.id === data);
            if (subject) {
                document.getElementById('payment-amount').value = subject.fee;
            }
        }
        document.getElementById(`modal-${type}`).classList.add('active');
    };

    window.hideModal = (type) => {
        document.getElementById(`modal-${type}`).classList.remove('active');
    };

    // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©
    window.editSubject = (id) => {
        const subject = state.subjects.find(s => s.id === id);
        if (!subject) return;

        document.getElementById('edit-subject-id').value = id;
        document.getElementById('edit-subject-name').value = subject.name;
        document.getElementById('edit-subject-fee').value = subject.fee;
        document.getElementById('edit-subject-time').value = subject.time || '';

        const container = document.getElementById('edit-days-selector');
        container.innerHTML = '';
        WEEKDAYS.forEach(day => {
            const div = document.createElement('div');
            div.className = `day-option ${subject.days?.includes(day) ? 'selected' : ''}`;
            div.textContent = day;
            div.onclick = () => div.classList.toggle('selected');
            container.appendChild(div);
        });

        document.getElementById('modal-edit-subject').classList.add('active');
    };

    window.updateSubject = async () => {
        const id = document.getElementById('edit-subject-id').value;
        const name = document.getElementById('edit-subject-name').value.trim();
        const fee = document.getElementById('edit-subject-fee').value;
        const time = document.getElementById('edit-subject-time').value;
        const days = Array.from(document.querySelectorAll('#edit-days-selector .selected')).map(el => el.textContent);

        if (!name || !fee || days.length === 0) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id), {
                name, fee: parseFloat(fee), time, days
            });
            hideModal('edit-subject');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    function renderDaysSelector(selectorId) {
        const container = document.getElementById(selectorId);
        container.innerHTML = '';
        WEEKDAYS.forEach(day => {
            const div = document.createElement('div');
            div.className = 'day-option';
            div.textContent = day;
            div.onclick = () => div.classList.toggle('selected');
            container.appendChild(div);
        });
    }

    // Ø§Ù„Ø·Ù„Ø§Ø¨
    window.addStudent = async () => {
        const name = document.getElementById('student-name').value.trim();
        if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…');
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), { name });
            document.getElementById('student-name').value = '';
            hideModal('student');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ù…ÙˆØ§Ø¯
    window.addSubject = async () => {
        const studentId = document.getElementById('subject-student-id').value;
        const name = document.getElementById('subject-name').value.trim();
        const fee = document.getElementById('subject-fee').value;
        const time = document.getElementById('subject-time').value;
        
        const days = Array.from(document.querySelectorAll('#days-selector .selected')).map(el => el.textContent);

        if (!studentId || !name || !fee || days.length === 0) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'subjects'), {
                studentId, name, fee: parseFloat(fee), time, days
            });
            hideModal('subject');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deleteSubject = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ø­ØµØµ
    window.addAttendance = async () => {
        const subjectId = document.getElementById('attendance-subject-id').value;
        const date = document.getElementById('attendance-date').value;
        const status = document.querySelector('input[name="attendance-status"]:checked').value;

        if (!subjectId || !date) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const exists = state.attendance.find(a => a.subjectId === subjectId && a.date === date);
        if (exists) return alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                status
            });
            hideModal('attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.editAttendance = (id) => {
        const a = state.attendance.find(a => a.id === id);
        if (!a) return;

        document.getElementById('edit-attendance-id').value = id;
        document.getElementById('edit-attendance-date').value = a.date;
        
        const radio = document.querySelector(`input[name="edit-attendance-status"][value="${a.status}"]`);
        if (radio) radio.checked = true;

        document.getElementById('modal-edit-attendance').classList.add('active');
    };

    window.updateAttendance = async () => {
        const id = document.getElementById('edit-attendance-id').value;
        const date = document.getElementById('edit-attendance-date').value;
        const status = document.querySelector('input[name="edit-attendance-status"]:checked').value;

        if (!id || !date || !status) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id), {
                date, day, status
            });
            hideModal('edit-attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deleteAttendance = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
    window.addPayment = async () => {
        const subjectId = document.getElementById('payment-subject-id').value;
        const date = document.getElementById('payment-date').value;
        const amount = document.getElementById('payment-amount').value;

        if (!subjectId || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'payments'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                amount: parseFloat(amount)
            });
            hideModal('payment');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.editPayment = (id) => {
        const p = state.payments.find(p => p.id === id);
        if (!p) return;

        document.getElementById('edit-payment-id').value = id;
        document.getElementById('edit-payment-date').value = p.date;
        document.getElementById('edit-payment-amount').value = p.amount;

        document.getElementById('modal-edit-payment').classList.add('active');
    };

    window.updatePayment = async () => {
        const id = document.getElementById('edit-payment-id').value;
        const date = document.getElementById('edit-payment-date').value;
        const amount = document.getElementById('edit-payment-amount').value;

        if (!id || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id), {
                date, day, amount: parseFloat(amount)
            });
            hideModal('edit-payment');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    window.deletePayment = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };

    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØµ
    window.showSessionsDetail = (type, id, filter = 'all') => {
        let title = '';
        let sessions = [];

        if (type === 'all') {
            const student = state.students.find(s => s.id === id);
            title = `ğŸ“‹ Ø­ØµØµ ${student?.name || ''}`;
            sessions = state.attendance.filter(a => a.studentId === id);
        } else if (type === 'present') {
            const student = state.students.find(s => s.id === id);
            title = `âœ… Ø­Ø¶ÙˆØ± ${student?.name || ''}`;
            sessions = state.attendance.filter(a => a.studentId === id && a.status === 'Ø­Ø¶ÙˆØ±');
        } else if (type === 'absent') {
            const student = state.students.find(s => s.id === id);
            title = `âŒ ØºÙŠØ§Ø¨ ${student?.name || ''}`;
            sessions = state.attendance.filter(a => a.studentId === id && a.status === 'ØºÙŠØ§Ø¨');
        } else if (type === 'subject') {
            const subject = state.subjects.find(s => s.id === id);
            if (filter === 'all') {
                title = `ğŸ“š ÙƒÙ„ Ø­ØµØµ ${subject?.name || ''}`;
                sessions = state.attendance.filter(a => a.subjectId === id);
            } else if (filter === 'present') {
                title = `âœ… Ø­Ø¶ÙˆØ± ${subject?.name || ''}`;
                sessions = state.attendance.filter(a => a.subjectId === id && a.status === 'Ø­Ø¶ÙˆØ±');
            } else if (filter === 'absent') {
                title = `âŒ ØºÙŠØ§Ø¨ ${subject?.name || ''}`;
                sessions = state.attendance.filter(a => a.subjectId === id && a.status === 'ØºÙŠØ§Ø¨');
            }
        }

        sessions.sort((a, b) => new Date(a.date) - new Date(b.date));

        document.getElementById('sessions-modal-title').textContent = title;

        const container = document.getElementById('sessions-list-container');
        if (sessions.length === 0) {
            container.innerHTML = '<div class="empty py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ</div>';
        } else {
            let html = '';
            sessions.forEach((session, index) => {
                const subject = state.subjects.find(s => s.id === session.subjectId);
                html += `
                    <div class="session-item">
                        <div class="session-number">${toArabic(index + 1)}</div>
                        <div class="session-info">
                            <div class="session-date">${subject?.name || ''} - ${session.date}</div>
                            <div class="session-day">${session.day || ''}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span class="session-status-badge ${session.status === 'Ø­Ø¶ÙˆØ±' ? 'status-present' : 'status-absent'}">
                                ${session.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'}
                            </span>
                            <button class="session-delete-btn" onclick="deleteAttendanceFromModal('${session.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        document.getElementById('modal-sessions-detail').classList.add('active');
    };

    window.deleteAttendanceFromModal = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ø­ØµØ©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            setTimeout(() => { render(); }, 100);
        } catch (e) {
            alert('Ø®Ø·Ø£');
        }
    };
</script>

<!-- Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ -->
<div class="toast" id="toast">âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸</div>

</body>
</html>
