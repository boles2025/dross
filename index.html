<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø±ÙˆØ³ | Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø®Ø· Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
            padding: 16px 12px 100px 12px;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .student-card {
            background: white;
            border-radius: 32px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .student-header {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            color: white;
            padding: 20px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .subject-card {
            background: #ffffff;
            border-radius: 28px;
            padding: 20px;
            margin: 12px 16px 16px 16px;
            border: 1px solid #eef2f6;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.02);
        }

        /* Ø­Ø§Ù„Ø© Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± - Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± */
        .subject-card.completed-cycle {
            background: #fef2f2;
            border-color: #fecaca;
            border-width: 2px;
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­ØµØ© 8 - Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø§Ù„Ø¯ÙØ¹ */
        .subject-card.need-payment {
            background: #fffbeb;
            border-color: #fcd34d;
            border-width: 2px;
            animation: pulse-warning 2s infinite;
        }

        @keyframes pulse-warning {
            0% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(252, 211, 77, 0); }
            100% { box-shadow: 0 0 0 0 rgba(252, 211, 77, 0); }
        }

        .progress-bar {
            background: #e9edf2;
            height: 12px;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            border-radius: 20px;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f59e0b, #f97316);
        }

        .month-badge {
            background: #f1f5f9;
            padding: 6px 14px;
            border-radius: 40px;
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .month-badge.paid {
            background: #dcfce7;
            color: #166534;
        }

        .month-badge.pending {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 16px 0;
        }

        .stat-item {
            background: #f8fafc;
            padding: 12px 8px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid #eef2f6;
            transition: all 0.2s;
            cursor: pointer;
        }

        .stat-item:hover {
            background: #eef2f6;
        }

        .today-class {
            background: linear-gradient(145deg, #2563eb, #4f46e5);
            color: white;
            border-radius: 32px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .payment-row {
            background: #f8fafc;
            border-radius: 18px;
            padding: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eef2f6;
        }

        .fab-button {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            font-size: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 36px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 28px 20px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
        }

        .input-field {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #eef2f6;
            border-radius: 24px;
            margin-bottom: 16px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: #3b82f6;
            outline: none;
        }

        .day-chip {
            background: #f1f5f9;
            padding: 12px 16px;
            border-radius: 40px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            flex: 1;
            text-align: center;
            min-width: 70px;
        }

        .day-chip.selected {
            background: #1e293b;
            color: white;
            border-color: #3b82f6;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 16px 32px;
            border-radius: 60px;
            font-weight: 600;
            display: none;
            z-index: 2001;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .month-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #eef2f6;
            cursor: pointer;
            transition: all 0.2s;
        }

        .month-card:hover {
            background: #f8fafc;
        }

        .month-card.completed {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .session-item {
            background: #f8fafc;
            border-radius: 18px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eef2f6;
        }

        .add-student-header {
            background: #eef2f6;
            border-radius: 60px;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-student-header:hover {
            background: #e2e8f0;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>

<div class="max-w-4xl mx-auto">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
    <div class="flex justify-between items-center mb-6">
        <div class="bg-white px-5 py-3 rounded-full shadow-sm flex items-center gap-2">
            <i class="fas fa-graduation-cap text-indigo-600 text-xl"></i>
            <span class="font-bold text-gray-800">Ø¨ÙˆÙ„Ø³ Ø³Ù…ÙŠØ±</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white px-5 py-3 rounded-full shadow-sm">
                <i class="fas fa-users ml-2"></i>
                <span class="font-bold" id="total-count">0</span>
            </div>
            <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
            <div class="add-student-header" onclick="showModal('student')">
                <i class="fas fa-plus text-indigo-600 ml-1"></i>
                <span class="font-bold text-indigo-600">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</span>
            </div>
        </div>
    </div>

    <!-- Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ… -->
    <div class="today-class">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <i class="fas fa-calendar-day text-2xl"></i>
                <span class="text-2xl font-bold">Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…</span>
            </div>
            <span class="bg-white/30 backdrop-blur px-5 py-2 rounded-full text-xl font-bold" id="today-count">0</span>
        </div>
        <div id="today-list" class="space-y-3"></div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div id="alerts-section" class="mb-6" style="display: none;">
        <div class="flex items-center gap-2 mb-4">
            <i class="fas fa-bell text-red-500 text-xl"></i>
            <span class="font-bold text-xl text-gray-800">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¯ÙØ¹</span>
            <span class="bg-red-500 text-white px-3 py-1 rounded-full text-sm mr-auto" id="alert-count">0</span>
        </div>
        <div id="alerts-list" class="space-y-3"></div>
    </div>

    <!-- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <div id="cards-container" class="space-y-4"></div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ -->
<div class="modal" id="modal-student">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
        <input type="text" id="student-name" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <div class="flex gap-3">
            <button class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ©</button>
            <button class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('student')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© -->
<div class="modal" id="modal-subject">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">ğŸ“š Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <input type="hidden" id="subject-student-id">
        <input type="text" id="subject-name" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="number" id="subject-fee" class="input-field" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ">
        <input type="text" id="subject-time" class="input-field" placeholder="Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ø§Ù„: 4:00 Ø¹ØµØ±Ø§Ù‹)">
        <div class="mb-3 font-bold text-gray-700">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
        <div class="flex flex-wrap gap-2 mb-5" id="days-selector"></div>
        <div class="flex gap-3">
            <button class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold" onclick="addSubject()">Ø­ÙØ¸</button>
            <button class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('subject')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø© -->
<div class="modal" id="modal-edit-subject">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø©</h2>
        <input type="hidden" id="edit-subject-id">
        <input type="text" id="edit-subject-name" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
        <input type="number" id="edit-subject-fee" class="input-field" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ">
        <input type="text" id="edit-subject-time" class="input-field" placeholder="Ø§Ù„ÙˆÙ‚Øª (Ù…Ø«Ø§Ù„: 4:00 Ø¹ØµØ±Ø§Ù‹)">
        <div class="mb-3 font-bold text-gray-700">Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø©</div>
        <div class="flex flex-wrap gap-2 mb-5" id="edit-days-selector"></div>
        <div class="flex gap-3">
            <button class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold" onclick="updateSubject()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('edit-subject')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-attendance">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©</h2>
        <input type="hidden" id="attendance-subject-id">
        <input type="date" id="attendance-date" class="input-field">
        <div class="flex gap-3 mb-5">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="Ø­Ø¶ÙˆØ±" checked class="hidden peer">
                <div class="text-center p-4 border-2 rounded-2xl peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-600 font-bold">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-4 border-2 rounded-2xl peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-600 font-bold">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>
        <div class="flex gap-3">
            <button class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold" onclick="addAttendance()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹ -->
<div class="modal" id="modal-payment">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹</h2>
        <input type="hidden" id="payment-subject-id">
        <input type="date" id="payment-date" class="input-field">
        <input type="number" id="payment-amount" class="input-field" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹">
        <div class="flex gap-3">
            <button class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold" onclick="addPayment()">ØªØ³Ø¬ÙŠÙ„</button>
            <button class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø­ØµØµ -->
<div class="modal" id="modal-sessions">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6" id="sessions-title">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ</h2>
        <div id="sessions-list" class="max-h-96 overflow-y-auto space-y-3"></div>
        <div class="mt-5">
            <button class="w-full bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('sessions')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ù‡Ø± -->
<div class="modal" id="modal-months">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6" id="months-title">ğŸ“† Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h2>
        <div id="months-list" class="max-h-96 overflow-y-auto space-y-3"></div>
        <div class="mt-5">
            <button class="w-full bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('months')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø­ØµØµ Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯ -->
<div class="modal" id="modal-month-sessions">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6" id="month-sessions-title">ğŸ“… Ø­ØµØµ Ø§Ù„Ø´Ù‡Ø±</h2>
        <div id="month-sessions-list" class="max-h-96 overflow-y-auto space-y-3"></div>
        <div class="mt-5">
            <button class="w-full bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('month-sessions')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹ -->
<div class="modal" id="modal-payment-reports">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6" id="reports-title">ğŸ’° Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h2>
        <div id="payment-reports-list" class="max-h-96 overflow-y-auto space-y-3"></div>
        <div class="mt-5">
            <button class="w-full bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('payment-reports')">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹ -->
<div class="modal" id="modal-edit-payment">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹</h2>
        <input type="hidden" id="edit-payment-id">
        <input type="date" id="edit-payment-date" class="input-field">
        <input type="number" id="edit-payment-amount" class="input-field" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <div class="flex gap-3">
            <button class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold" onclick="updatePayment()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('edit-payment')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ© -->
<div class="modal" id="modal-edit-attendance">
    <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­ØµØ©</h2>
        <input type="hidden" id="edit-attendance-id">
        <input type="date" id="edit-attendance-date" class="input-field">
        <div class="flex gap-3 mb-5">
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="Ø­Ø¶ÙˆØ±" checked class="hidden peer">
                <div class="text-center p-4 border-2 rounded-2xl peer-checked:bg-green-500 peer-checked:text-white font-bold">âœ… Ø­Ø¶ÙˆØ±</div>
            </label>
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="edit-attendance-status" value="ØºÙŠØ§Ø¨" class="hidden peer">
                <div class="text-center p-4 border-2 rounded-2xl peer-checked:bg-red-500 peer-checked:text-white font-bold">âŒ ØºÙŠØ§Ø¨</div>
            </label>
        </div>
        <div class="flex gap-3">
            <button class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold" onclick="updateAttendance()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-2xl font-bold" onclick="hideModal('edit-attendance')">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ -->
<div class="toast" id="toast">âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAYbNXkNQy32UnbsUUrTXyoJluZRS3wP1w",
        authDomain: "droos-33ede.firebaseapp.com",
        projectId: "droos-33ede",
        storageBucket: "droos-33ede.firebasestorage.app",
        messagingSenderId: "807210060374",
        appId: "1:807210060374:web:3bdf1e15e44a1795f289f7"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'droos-app-v1';

    const state = {
        students: [],
        subjects: [],
        attendance: [],
        payments: [],
        expanded: {}
    };

    const WEEKDAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];

    function toArabic(num) {
        const arabic = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        return num?.toString().replace(/\d/g, d => arabic[d]) || 'Ù ';
    }

    function showToast(msg) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 2000);
    }

    // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ø¯Ø©
    function calculateSubjectStats(subjectId) {
        const attendance = state.attendance
            .filter(a => a.subjectId === subjectId)
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const payments = state.payments
            .filter(p => p.subjectId === subjectId)
            .sort((a, b) => new Date(a.date) - new Date(b.date));

        const totalSessions = attendance.length;
        
        // Ø§Ù„Ø´Ù‡Ø± = 8 Ø­ØµØµ
        const totalMonths = Math.floor(totalSessions / 8);
        const currentMonthSessions = totalSessions % 8;
        const paidMonths = payments.length;
        const pendingMonths = totalMonths - paidMonths;
        const isMonthComplete = currentMonthSessions === 0 && totalMonths > 0;
        const needPayment = currentMonthSessions === 8; // ÙˆØµÙ„ Ù„Ù„Ø­ØµØ© Ø§Ù„Ø«Ø§Ù…Ù†Ø© ÙˆÙŠØ­ØªØ§Ø¬ Ø¯ÙØ¹
        const currentMonthNumber = totalMonths + 1;
        const progress = (currentMonthSessions / 8) * 100;

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­ØµØµ Ù„ÙƒÙ„ Ø´Ù‡Ø±
        const months = [];
        for (let i = 0; i < totalMonths; i++) {
            const start = i * 8;
            const end = start + 8;
            months.push({
                number: i + 1,
                sessions: attendance.slice(start, end)
            });
        }

        return {
            totalSessions,
            totalMonths,
            currentMonthSessions,
            paidMonths,
            pendingMonths,
            isMonthComplete,
            needPayment,
            currentMonthNumber,
            progress,
            months,
            attendance
        };
    }

    signInAnonymously(auth).then(() => {
        const path = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

        onSnapshot(path('students'), (snap) => {
            state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('total-count').textContent = state.students.length;
            renderAll();
        });

        onSnapshot(path('subjects'), (snap) => {
            state.subjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAll();
        });

        onSnapshot(path('attendance'), (snap) => {
            state.attendance = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAll();
        });

        onSnapshot(path('payments'), (snap) => {
            state.payments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderAll();
        });
    });

    function renderAll() {
        renderTodayClasses();
        renderAlerts();
        renderCards();
    }

    function renderTodayClasses() {
        const today = new Date().toISOString().split('T')[0];
        const todayDay = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
        
        const todayClasses = state.subjects
            .filter(s => s.days?.includes(todayDay))
            .map(subject => {
                const student = state.students.find(s => s.id === subject.studentId);
                const attendance = state.attendance.find(a => a.subjectId === subject.id && a.date === today);
                return { subject, student, status: attendance?.status || 'pending' };
            });

        document.getElementById('today-count').textContent = todayClasses.length;

        if (todayClasses.length === 0) {
            document.getElementById('today-list').innerHTML = '<div class="bg-white/20 backdrop-blur rounded-3xl p-6 text-center text-white">ğŸŒŸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ø§Ù„ÙŠÙˆÙ…</div>';
            return;
        }

        let html = '';
        todayClasses.forEach(c => {
            html += `
                <div class="bg-white/20 backdrop-blur p-4 rounded-2xl flex justify-between items-center">
                    <div>
                        <span class="font-bold text-white">${c.student?.name}</span>
                        <span class="bg-white/30 text-white px-3 py-1 rounded-full text-sm mr-2">${c.subject.name}</span>
                        ${c.subject.time ? `<span class="text-white/80 text-sm block mt-1">ğŸ• ${c.subject.time}</span>` : ''}
                    </div>
                    ${c.status === 'pending' 
                        ? `<button class="bg-white text-indigo-600 px-6 py-2 rounded-full font-bold" onclick="quickRegister('${c.subject.id}')">ØªØ³Ø¬ÙŠÙ„</button>`
                        : `<span class="px-4 py-2 bg-white/30 text-white rounded-full text-sm">${c.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'} ${c.status}</span>`
                    }
                </div>
            `;
        });
        document.getElementById('today-list').innerHTML = html;
    }

    function renderAlerts() {
        const alerts = [];

        state.subjects.forEach(subject => {
            const stats = calculateSubjectStats(subject.id);
            if (stats.pendingMonths > 0) {
                const student = state.students.find(s => s.id === subject.studentId);
                alerts.push({
                    subject: subject.name,
                    student: student?.name,
                    pendingMonths: stats.pendingMonths,
                    amount: stats.pendingMonths * subject.fee,
                    totalMonths: stats.totalMonths
                });
            }
        });

        const section = document.getElementById('alerts-section');
        if (alerts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        document.getElementById('alert-count').textContent = alerts.length;

        let html = '';
        alerts.forEach(a => {
            html += `
                <div class="bg-white p-4 rounded-2xl shadow-sm border-r-4 border-red-500 flex justify-between items-center">
                    <div>
                        <div class="font-bold">${a.subject}</div>
                        <div class="text-sm text-gray-600">${a.student}</div>
                    </div>
                    <div class="text-left">
                        <div class="text-red-600 font-bold">${toArabic(a.pendingMonths)} Ø£Ø´Ù‡Ø±</div>
                        <div class="text-sm">${toArabic(a.amount)} Ø¬.Ù…</div>
                    </div>
                </div>
            `;
        });
        document.getElementById('alerts-list').innerHTML = html;
    }

    function renderCards() {
        if (state.students.length === 0) {
            document.getElementById('cards-container').innerHTML = `
                <div class="bg-white rounded-4xl p-12 text-center">
                    <i class="fas fa-child text-6xl text-indigo-300 mb-4"></i>
                    <p class="text-gray-500 text-xl mb-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯</p>
                    <button class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold" onclick="showModal('student')">
                        <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨
                    </button>
                </div>
            `;
            return;
        }

        let html = '';
        state.students.forEach(student => {
            const isExpanded = state.expanded[student.id] || false;
            const subjects = state.subjects.filter(s => s.studentId === student.id);
            
            html += `
                <div class="student-card">
                    <div class="student-header" onclick="toggleCard('${student.id}')">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-2xl">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div>
                                <div class="text-xl font-bold">${student.name}</div>
                                <div class="text-sm text-white/80">${subjects.length} Ù…ÙˆØ§Ø¯</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-down text-2xl transition-transform ${isExpanded ? 'rotate-180' : ''}"></i>
                    </div>

                    <div class="transition-all duration-300 overflow-hidden" style="${isExpanded ? 'max-height: 2000px;' : 'max-height: 0;'}">
                        ${subjects.length === 0 
                            ? '<div class="p-8 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø¶Ø§ÙØ©</div>'
                            : subjects.map(s => renderSubject(s)).join('')
                        }
                        
                        <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
                        <div class="p-4 pt-0">
                            <button class="w-full bg-indigo-50 text-indigo-600 py-4 rounded-2xl font-bold border-2 border-indigo-100" onclick="showModal('subject', '${student.id}')">
                                <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        document.getElementById('cards-container').innerHTML = html;
    }

    function renderSubject(subject) {
        const stats = calculateSubjectStats(subject.id);
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
        let cardClass = 'subject-card';
        if (stats.needPayment) {
            cardClass += ' need-payment'; // Ù„ÙˆÙ† Ø£ØµÙØ± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ø¯ÙØ¹
        } else if (stats.isMonthComplete) {
            cardClass += ' completed-cycle'; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø´Ù‡Ø±
        }
        
        return `
            <div class="${cardClass}">
                <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ø¯Ø© -->
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-xl">${subject.name}</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-sm text-gray-500"><i class="far fa-clock ml-1"></i>${subject.time || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                            <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-bold">${toArabic(subject.fee)} Ø¬.Ù…</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="w-10 h-10 bg-blue-100 text-blue-600 rounded-2xl" onclick="editSubject('${subject.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="w-10 h-10 bg-red-100 text-red-600 rounded-2xl" onclick="deleteSubject('${subject.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- Ø£ÙŠØ§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© -->
                <div class="flex flex-wrap gap-1 mb-4">
                    ${WEEKDAYS.map(day => `
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${subject.days?.includes(day) ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-400'}">
                            ${day}
                        </span>
                    `).join('')}
                </div>

                <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                <div class="stats-grid">
                    <div class="stat-item" onclick="showSessions('subject', '${subject.id}')">
                        <div class="text-2xl font-bold text-indigo-600">${toArabic(stats.totalSessions)}</div>
                        <div class="text-xs text-gray-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ</div>
                    </div>
                    <div class="stat-item" onclick="showMonths('${subject.id}', '${subject.name}')">
                        <div class="text-2xl font-bold text-indigo-600">${toArabic(stats.totalMonths)}</div>
                        <div class="text-xs text-gray-500">Ø´Ù‡Ø± Ù…ÙƒØªÙ…Ù„</div>
                    </div>
                    <div class="stat-item" onclick="showPaymentReports('${subject.id}')">
                        <div class="text-2xl font-bold ${stats.paidMonths === stats.totalMonths ? 'text-green-600' : 'text-orange-600'}">
                            ${toArabic(stats.paidMonths)} / ${toArabic(stats.totalMonths)}
                        </div>
                        <div class="text-xs text-gray-500">Ù…Ø¯ÙÙˆØ¹</div>
                    </div>
                </div>

                <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
                <div class="mb-3">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-bold">Ø§Ù„Ø´Ù‡Ø± ${toArabic(stats.currentMonthNumber)}</span>
                        <span class="${stats.needPayment ? 'text-orange-600 font-bold' : ''}">
                            ${toArabic(stats.currentMonthSessions)} / 8
                            ${stats.needPayment ? ' (ÙŠØ­ØªØ§Ø¬ Ø¯ÙØ¹)' : ''}
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${stats.pendingMonths > 0 ? 'warning' : ''}" style="width: ${stats.progress}%"></div>
                    </div>
                </div>

                <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ -->
                <div class="flex gap-2 mb-4">
                    <span class="month-badge ${stats.paidMonths > 0 ? 'paid' : ''}">
                        <i class="fas fa-check-circle ml-1"></i>Ù…Ø¯ÙÙˆØ¹: ${toArabic(stats.paidMonths)}
                    </span>
                    ${stats.pendingMonths > 0 ? `
                        <span class="month-badge pending">
                            <i class="fas fa-exclamation-circle ml-1"></i>Ù…Ø³ØªØ­Ù‚: ${toArabic(stats.pendingMonths)}
                        </span>
                    ` : ''}
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div class="flex gap-2">
                    <button class="flex-1 bg-green-500 text-white py-3 rounded-2xl font-bold text-sm" onclick="showModal('attendance', '${subject.id}')">
                        <i class="fas fa-pen ml-1"></i> ØªØ³Ø¬ÙŠÙ„ Ø­ØµØ©
                    </button>
                    <button class="flex-1 bg-blue-500 text-white py-3 rounded-2xl font-bold text-sm" onclick="showModal('payment', '${subject.id}')">
                        <i class="fas fa-money-bill ml-1"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹
                    </button>
                </div>
            </div>
        `;
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø§Ø¯Ø©
    window.editSubject = (subjectId) => {
        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        document.getElementById('edit-subject-id').value = subjectId;
        document.getElementById('edit-subject-name').value = subject.name;
        document.getElementById('edit-subject-fee').value = subject.fee;
        document.getElementById('edit-subject-time').value = subject.time || '';

        // ØªØ¬Ù‡ÙŠØ² Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø£ÙŠØ§Ù…
        const selector = document.getElementById('edit-days-selector');
        selector.innerHTML = '';
        WEEKDAYS.forEach(day => {
            const div = document.createElement('div');
            div.className = `day-chip ${subject.days?.includes(day) ? 'selected' : ''}`;
            div.textContent = day;
            div.onclick = () => div.classList.toggle('selected');
            selector.appendChild(div);
        });

        document.getElementById('modal-edit-subject').classList.add('active');
    };

    window.updateSubject = async () => {
        const id = document.getElementById('edit-subject-id').value;
        const name = document.getElementById('edit-subject-name').value.trim();
        const fee = document.getElementById('edit-subject-fee').value;
        const time = document.getElementById('edit-subject-time').value;
        const days = Array.from(document.querySelectorAll('#edit-days-selector .selected')).map(el => el.textContent);

        if (!name || !fee || days.length === 0) {
            return alert('Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id), {
                name,
                fee: parseFloat(fee),
                time,
                days
            });
            hideModal('edit-subject');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        }
    };

    // Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­ØµØµ
    window.showSessions = (type, id) => {
        let sessions = [];
        let title = '';

        if (type === 'subject') {
            const subject = state.subjects.find(s => s.id === id);
            title = `ğŸ“š Ø³Ø¬Ù„ Ø­ØµØµ ${subject?.name}`;
            sessions = state.attendance.filter(a => a.subjectId === id);
        }

        sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        document.getElementById('sessions-title').textContent = title;
        
        let html = '';
        sessions.forEach((s) => {
            const sessionNumber = state.attendance.filter(a => a.subjectId === s.subjectId && new Date(a.date) <= new Date(s.date)).length;
            const monthNumber = Math.ceil(sessionNumber / 8);
            
            html += `
                <div class="session-item">
                    <div>
                        <div class="font-bold">${s.date}</div>
                        <div class="text-xs text-gray-500">${s.day || ''} - Ø§Ù„Ø´Ù‡Ø± ${toArabic(monthNumber)}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1 rounded-full text-sm ${s.status === 'Ø­Ø¶ÙˆØ±' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${s.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'}
                        </span>
                        <button class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full" onclick="editAttendance('${s.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="w-8 h-8 bg-red-100 text-red-600 rounded-full" onclick="deleteAttendance('${s.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        if (sessions.length === 0) {
            html = '<div class="text-center py-8 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù…Ø³Ø¬Ù„Ø©</div>';
        }

        document.getElementById('sessions-list').innerHTML = html;
        document.getElementById('modal-sessions').classList.add('active');
    };

    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    window.showMonths = (subjectId, subjectName) => {
        const stats = calculateSubjectStats(subjectId);
        
        document.getElementById('months-title').textContent = `ğŸ“† Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© - ${subjectName}`;
        
        let html = '';
        stats.months.forEach(month => {
            const isPaid = month.number <= stats.paidMonths;
            html += `
                <div class="month-card ${isPaid ? 'completed' : ''}" onclick="showMonthSessions('${subjectId}', ${month.number})">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold text-lg">Ø§Ù„Ø´Ù‡Ø± ${toArabic(month.number)}</span>
                            <div class="text-sm text-gray-500">${toArabic(month.sessions.length)} Ø­ØµØµ</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-3 py-1 rounded-full text-sm ${isPaid ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${isPaid ? 'Ù…Ø¯ÙÙˆØ¹' : 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}
                            </span>
                            <i class="fas fa-chevron-left text-gray-400"></i>
                        </div>
                    </div>
                </div>
            `;
        });

        if (stats.months.length === 0) {
            html = '<div class="text-center py-8 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø´Ù‡Ø± Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø¹Ø¯</div>';
        }

        document.getElementById('months-list').innerHTML = html;
        document.getElementById('modal-months').classList.add('active');
    };

    // Ø¹Ø±Ø¶ Ø­ØµØµ Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯
    window.showMonthSessions = (subjectId, monthNumber) => {
        const stats = calculateSubjectStats(subjectId);
        const month = stats.months[monthNumber - 1];
        
        document.getElementById('month-sessions-title').textContent = `ğŸ“… Ø­ØµØµ Ø§Ù„Ø´Ù‡Ø± ${toArabic(monthNumber)}`;
        
        let html = '';
        month.sessions.forEach((s, index) => {
            html += `
                <div class="session-item">
                    <div>
                        <div class="font-bold">Ø§Ù„Ø­ØµØ© ${toArabic(index + 1)}</div>
                        <div class="text-sm">${s.date} - ${s.day || ''}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="px-3 py-1 rounded-full text-sm ${s.status === 'Ø­Ø¶ÙˆØ±' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${s.status === 'Ø­Ø¶ÙˆØ±' ? 'âœ…' : 'âŒ'}
                        </span>
                        <button class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full" onclick="editAttendance('${s.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="w-8 h-8 bg-red-100 text-red-600 rounded-full" onclick="deleteAttendance('${s.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        document.getElementById('month-sessions-list').innerHTML = html;
        document.getElementById('modal-month-sessions').classList.add('active');
    };

    // Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹
    window.showPaymentReports = (subjectId) => {
        const subject = state.subjects.find(s => s.id === subjectId);
        const payments = state.payments
            .filter(p => p.subjectId === subjectId)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        document.getElementById('reports-title').textContent = `ğŸ’° Ù…Ø¯ÙÙˆØ¹Ø§Øª ${subject?.name}`;
        
        let html = '';
        payments.forEach(p => {
            html += `
                <div class="payment-row">
                    <div>
                        <div class="font-bold">${p.date}</div>
                        <div class="text-sm text-gray-500">${p.day || ''}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-green-600">${toArabic(p.amount)} Ø¬.Ù…</span>
                        <button class="w-10 h-10 bg-blue-100 text-blue-600 rounded-2xl" onclick="editPayment('${p.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="w-10 h-10 bg-red-100 text-red-600 rounded-2xl" onclick="deletePayment('${p.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        if (payments.length === 0) {
            html = '<div class="text-center py-8 text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
        }

        document.getElementById('payment-reports-list').innerHTML = html;
        document.getElementById('modal-payment-reports').classList.add('active');
    };

    // ØªØ¹Ø¯ÙŠÙ„ Ø­ØµØ©
    window.editAttendance = (attendanceId) => {
        const attendance = state.attendance.find(a => a.id === attendanceId);
        if (!attendance) return;

        document.getElementById('edit-attendance-id').value = attendanceId;
        document.getElementById('edit-attendance-date').value = attendance.date;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
        const radios = document.querySelectorAll('input[name="edit-attendance-status"]');
        radios.forEach(radio => {
            if (radio.value === attendance.status) {
                radio.checked = true;
            }
        });
        
        hideModal('sessions');
        hideModal('month-sessions');
        document.getElementById('modal-edit-attendance').classList.add('active');
    };

    window.updateAttendance = async () => {
        const id = document.getElementById('edit-attendance-id').value;
        const date = document.getElementById('edit-attendance-date').value;
        const status = document.querySelector('input[name="edit-attendance-status"]:checked')?.value;

        if (!id || !date || !status) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id), {
                date,
                status
            });
            hideModal('edit-attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        }
    };

    // ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹
    window.editPayment = (paymentId) => {
        const payment = state.payments.find(p => p.id === paymentId);
        if (!payment) return;

        document.getElementById('edit-payment-id').value = paymentId;
        document.getElementById('edit-payment-date').value = payment.date;
        document.getElementById('edit-payment-amount').value = payment.amount;
        
        hideModal('payment-reports');
        document.getElementById('modal-edit-payment').classList.add('active');
    };

    window.updatePayment = async () => {
        const id = document.getElementById('edit-payment-id').value;
        const date = document.getElementById('edit-payment-date').value;
        const amount = document.getElementById('edit-payment-amount').value;

        if (!id || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id), {
                date,
                amount: parseFloat(amount)
            });
            hideModal('edit-payment');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        }
    };

    // Ø­Ø°Ù Ø­ØµØ©
    window.deleteAttendance = async (id) => {
        if (!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­ØµØ©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'attendance', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
        }
    };

    // Ø­Ø°Ù Ø¯ÙØ¹
    window.deletePayment = async (id) => {
        if (!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙØ¹ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'payments', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
            hideModal('payment-reports');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
        }
    };

    // Ø­Ø°Ù Ù…Ø§Ø¯Ø©
    window.deleteSubject = async (id) => {
        if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø§Ø¯Ø©ØŸ')) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'subjects', id));
            showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
        }
    };

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ…
    window.toggleCard = (id) => {
        state.expanded[id] = !state.expanded[id];
        renderCards();
    };

    window.showModal = (type, data = null) => {
        if (type === 'subject' && data) {
            document.getElementById('subject-student-id').value = data;
            const selector = document.getElementById('days-selector');
            selector.innerHTML = '';
            WEEKDAYS.forEach(day => {
                const div = document.createElement('div');
                div.className = 'day-chip';
                div.textContent = day;
                div.onclick = () => div.classList.toggle('selected');
                selector.appendChild(div);
            });
        }
        if (type === 'attendance' && data) {
            document.getElementById('attendance-subject-id').value = data;
            document.getElementById('attendance-date').value = new Date().toISOString().split('T')[0];
        }
        if (type === 'payment' && data) {
            document.getElementById('payment-subject-id').value = data;
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            const subject = state.subjects.find(s => s.id === data);
            if (subject) {
                document.getElementById('payment-amount').value = subject.fee;
            }
        }
        document.getElementById(`modal-${type}`).classList.add('active');
    };

    window.hideModal = (type) => {
        document.getElementById(`modal-${type}`).classList.remove('active');
    };

    window.quickRegister = (subjectId) => {
        showModal('attendance', subjectId);
    };

    window.addStudent = async () => {
        const name = document.getElementById('student-name').value.trim();
        if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…');
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), { name });
            document.getElementById('student-name').value = '';
            hideModal('student');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        }
    };

    window.addSubject = async () => {
        const studentId = document.getElementById('subject-student-id').value;
        const name = document.getElementById('subject-name').value.trim();
        const fee = document.getElementById('subject-fee').value;
        const time = document.getElementById('subject-time').value;
        const days = Array.from(document.querySelectorAll('#days-selector .selected')).map(el => el.textContent);

        if (!studentId || !name || !fee || days.length === 0) {
            return alert('Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'subjects'), {
                studentId, name, fee: parseFloat(fee), time, days
            });
            hideModal('subject');
            showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
        }
    };

    window.addAttendance = async () => {
        const subjectId = document.getElementById('attendance-subject-id').value;
        const date = document.getElementById('attendance-date').value;
        const status = document.querySelector('input[name="attendance-status"]:checked')?.value;

        if (!subjectId || !date || !status) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const exists = state.attendance.find(a => a.subjectId === subjectId && a.date === date);
        if (exists) return alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'attendance'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                status
            });
            hideModal('attendance');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        }
    };

    window.addPayment = async () => {
        const subjectId = document.getElementById('payment-subject-id').value;
        const date = document.getElementById('payment-date').value;
        const amount = document.getElementById('payment-amount').value;

        if (!subjectId || !date || !amount) return alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');

        const subject = state.subjects.find(s => s.id === subjectId);
        if (!subject) return;

        const day = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long' });

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'payments'), {
                studentId: subject.studentId,
                subjectId,
                date,
                day,
                amount: parseFloat(amount)
            });
            hideModal('payment');
            showToast('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        } catch (e) {
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„');
        }
    };
</script>

</body>
</html>
